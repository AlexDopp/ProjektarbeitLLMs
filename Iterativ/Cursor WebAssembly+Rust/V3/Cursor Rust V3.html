<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Anki Lernfortschritt (lokal, JS + WASM)</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{padding:14px;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#020617;color:#e5e7eb}
h1,h2{margin:0}
.app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.4fr 1.6fr;grid-template-rows:auto auto;gap:12px}
@media(max-width:900px){.app{grid-template-columns:1fr}}
.header{grid-column:1/-1;background:#020617;border:1px solid #1f2937;border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;gap:10px}
.header-left small{display:block;font-size:.7rem;color:#9ca3af;text-transform:uppercase;letter-spacing:.16em;margin-bottom:3px}
.header-left h1{font-size:1.4rem}
.header-left div{font-size:.8rem;color:#9ca3af;margin-top:2px}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.pills{display:flex;flex-wrap:wrap;gap:4px}
.pill{font-size:.7rem;padding:3px 7px;border-radius:999px;border:1px solid #1f2937;background:#020617;color:#9ca3af;display:inline-flex;align-items:center;gap:5px}
.pill strong{color:#e5e7eb}
.pill-color{width:8px;height:8px;border-radius:50%}
.c-new{background:#38bdf8}.c-hard{background:#fb923c}.c-easy{background:#22c55e}.c-learned{background:#a855f7}
.badge-strong{border-color:#38bdf8;color:#38bdf8}
.card{background:#020617;border:1px solid #1f2937;border-radius:14px;padding:8px 10px;display:flex;flex-direction:column;gap:6px}
.card-header{display:flex;justify-content:space-between;align-items:center;font-size:.78rem;color:#9ca3af}
.card-header-title{font-size:.78rem;text-transform:uppercase;letter-spacing:.14em}
.section-title{font-size:.96rem;margin-top:1px;color:#e5e7eb}
.badge{font-size:.75rem;padding:2px 7px;border-radius:999px;border:1px solid #1f2937;background:#020617;color:#9ca3af}
.row{display:flex;gap:8px}
.col{flex:1;min-width:0}
@media(max-width:900px){.row{flex-direction:column}}
label{font-size:.78rem;color:#9ca3af;display:block;margin-top:2px;margin-bottom:2px}
input[type="text"],select,textarea{width:100%;background:#020617;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:5px 7px;font-size:.8rem;outline:none}
input[type="text"]:focus,select:focus,textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 1px #38bdf8}
input[type="file"]{font-size:.78rem;color:#9ca3af}
button{border-radius:999px;border:1px solid #1f2937;background:#020617;color:#e5e7eb;font-size:.78rem;padding:5px 9px;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
button.primary{background:linear-gradient(90deg,#22d3ee,#0ea5e9);border-color:#22d3ee;color:#0f172a}
button.small{font-size:.72rem;padding:3px 7px}
button.danger{border-color:#f97373;color:#fecaca}
button:disabled{opacity:.4;cursor:default}
button:not(:disabled):hover{filter:brightness(1.05)}
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 6px;border-radius:999px;border:1px solid #1f2937;background:#020617;font-size:.72rem;color:#9ca3af}
.chip input{margin:0}
.list{max-height:140px;overflow:auto;border-radius:8px;border:1px solid #1f2937;padding:3px;font-size:.76rem}
.item{display:flex;justify-content:space-between;align-items:center;padding:3px 5px;border-radius:6px}
.item:nth-child(odd){background:#020617}.item:nth-child(even){background:#020b23}
.item-main{display:flex;flex-direction:column;gap:1px}
.item-title{font-size:.8rem}
.item-sub{font-size:.7rem;color:#9ca3af}
.item-right{display:flex;align-items:center;gap:3px}
.small{font-size:.74rem;color:#9ca3af}
.metrics{display:flex;flex-wrap:wrap;gap:4px;font-size:.72rem;margin-top:3px}
.metric{padding:2px 6px;border-radius:999px;border:1px solid #1f2937;background:#020617;display:flex;gap:3px}
.metric span:first-child{font-weight:600;color:#e5e7eb}
.metric span:last-child{color:#9ca3af}
.progress{width:100%;height:6px;border-radius:999px;background:#020617;border:1px solid #1f2937;overflow:hidden;margin-top:3px}
.progress-fill{height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#22c55e);transition:width .25s ease}
.flashcard{border-radius:12px;border:1px solid #1f2937;background:#020617;padding:8px;min-height:80px;cursor:pointer;position:relative}
.flashcard-topic{font-size:.7rem;color:#93c5fd;text-transform:uppercase;letter-spacing:.14em}
.flashcard-front{margin-top:4px;font-size:.92rem}
.flashcard-back{margin-top:4px;font-size:.9rem;color:#c4d3ff}
.flashcard-sub{margin-top:4px;font-size:.72rem;color:#9ca3af}
.flashcard-status{position:absolute;top:5px;right:7px;font-size:.7rem;padding:2px 6px;border-radius:999px;border:1px solid #1f2937;background:#020617;color:#9ca3af}
.hidden{display:none}
.learning-bottom{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:5px}
.learning-meta{font-size:.72rem;color:#9ca3af;display:flex;flex-direction:column;gap:2px}
.diff-buttons{display:flex;flex-wrap:wrap;gap:4px}
.diff-new{border-color:#38bdf8;color:#7dd3fc}
.diff-hard{border-color:#fb923c;color:#fed7aa}
.diff-easy{border-color:#22c55e;color:#bbf7d0}
.diff-learned{border-color:#a855f7;color:#e9d5ff}
.tabs{display:inline-flex;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
.tabs button{border-radius:0;border:none;padding:3px 9px;font-size:.72rem}
.tabs button.active{background:#0f172a;color:#38bdf8}
.chart-box{border-radius:10px;border:1px solid #1f2937;padding:5px 7px;margin-top:3px}
.chart-header{display:flex;justify-content:space-between;align-items:center;font-size:.72rem;color:#9ca3af;margin-bottom:2px}
.legend{display:flex;flex-wrap:wrap;gap:3px}
.legend-item{display:flex;align-items:center;gap:3px;font-size:.7rem}
.legend-color{width:8px;height:8px;border-radius:2px}
svg{width:100%;height:130px}
.status-msg{font-size:.72rem;margin-top:3px}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="header-left">
      <small>Anki Decks · Lernziele · Lokales Tracking</small>
      <h1>Anki Lernfortschritt (Browser, Rust-WASM Kern)</h1>
      <div>Importiere Decks, verknüpfe Lernziele, führe Sessions durch – alles bleibt im LocalStorage.</div>
    </div>
    <div class="header-right">
      <div class="pills">
        <div class="pill"><strong id="hdr-total-cards">0</strong> Karten</div>
        <div class="pill"><strong id="hdr-learned">0%</strong> gelernt</div>
        <div class="pill"><strong id="hdr-time-today">0</strong> min heute</div>
      </div>
      <div class="pills">
        <div class="pill"><span class="pill-color c-new"></span>New</div>
        <div class="pill"><span class="pill-color c-hard"></span>Hard</div>
        <div class="pill"><span class="pill-color c-easy"></span>Easy</div>
        <div class="pill"><span class="pill-color c-learned"></span>Learned</div>
        <div class="pill badge-strong">Rust-WebAssembly-Kern · JS-Glue</div>
      </div>
    </div>
  </header>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-header-title">Decks · Import & Übersicht</div>
        <div class="section-title">Decks verwalten</div>
      </div>
      <span class="badge" id="deck-count">0 Decks</span>
    </div>
    <div class="row">
      <div class="col">
        <label for="deck-file">Anki-Decks importieren (JSON, mehrere möglich)</label>
        <input id="deck-file" type="file" accept=".json,application/json" multiple>
        <div style="margin-top:4px;display:flex;gap:5px;align-items:center">
          <button id="btn-clear" class="small danger">Alles löschen</button>
          <span id="import-status" class="status-msg small"></span>
        </div>
        <div style="margin-top:6px">
          <label>Aggregierte Kennzahlen</label>
          <div class="metrics">
            <div class="metric"><span id="m-total">0</span><span>Karten</span></div>
            <div class="metric"><span id="m-topics">0</span><span>Themen</span></div>
            <div class="metric"><span id="m-due">0</span><span>fällig</span></div>
            <div class="metric"><span id="m-overdue">0</span><span>überfällig</span></div>
          </div>
          <div class="progress"><div id="m-learned-bar" class="progress-fill"></div></div>
        </div>
      </div>
      <div class="col">
        <label>Importierte Decks</label>
        <div id="deck-list" class="list"></div>
        <div id="deck-list-empty" class="small">Noch keine Decks importiert. JSON-Format wie im Beispiel verwenden.</div>
        <div style="margin-top:5px">
          <label>Status-Filter (wirken auf Sessions & Statistiken)</label>
          <div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:2px">
            <label class="chip"><input type="checkbox" class="status-filter" value="new" checked>Neu</label>
            <label class="chip"><input type="checkbox" class="status-filter" value="hard" checked>Hard</label>
            <label class="chip"><input type="checkbox" class="status-filter" value="easy" checked>Easy</label>
            <label class="chip"><input type="checkbox" class="status-filter" value="learned" checked>Learned</label>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:6px">
      <label>Kartenstatus nach Thema (neu, gelernt, fällig, überfällig)</label>
      <div class="chart-box">
        <div class="chart-header">
          <span>Statusverteilung</span>
          <div class="legend">
            <div class="legend-item"><span class="legend-color" style="background:#38bdf8"></span><span>Neu</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#fb923c"></span><span>Fällig / schwer</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#22c55e"></span><span>Leicht</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#a855f7"></span><span>Gelernt</span></div>
          </div>
        </div>
        <svg id="status-chart"></svg>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-header-title">Lernziele & Sessions</div>
        <div class="section-title">Lernziele definieren</div>
      </div>
      <span class="badge" id="goal-count">0 Lernziele</span>
    </div>
    <div class="row">
      <div class="col">
        <label for="goal-name">Neues Lernziel</label>
        <input id="goal-name" type="text" placeholder="z. B. 'Grundlagen wiederholen'">
        <div style="margin-top:5px">
          <label>Decks diesem Lernziel zuordnen</label>
          <div id="goal-decks" class="list small">Noch keine Decks verfügbar.</div>
        </div>
        <div style="margin-top:5px;display:flex;gap:5px;align-items:center">
          <button id="btn-add-goal" class="primary small">Lernziel anlegen</button>
          <span id="goal-status" class="status-msg small"></span>
        </div>
      </div>
      <div class="col">
        <label>Bestehende Lernziele</label>
        <div id="goal-list" class="list"></div>
        <div id="goal-list-empty" class="small">Noch keine Lernziele definiert.</div>
        <div style="margin-top:5px">
          <label>Aktive Lernsitzung</label>
          <div style="display:flex;gap:5px;align-items:center;margin-top:2px">
            <select id="session-goal" style="flex:1">
              <option value="">Lernziel wählen…</option>
            </select>
            <button id="btn-session-toggle" class="primary small">Session starten</button>
          </div>
          <div class="metrics">
            <div class="metric"><span id="s-cards">0</span><span>Karten in Session</span></div>
            <div class="metric"><span id="s-min">0</span><span>Minuten</span></div>
            <div class="metric"><span id="s-rate">0</span><span>Karten / 10 min</span></div>
          </div>
          <div class="progress"><div id="s-progress" class="progress-fill"></div></div>
          <div id="session-info" class="small" style="margin-top:3px">Keine aktive Session.</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-header-title">Lernen · Karte für Karte</div>
        <div class="section-title">Lernsessions durchführen</div>
      </div>
      <span class="badge badge-strong" id="learning-badge">Wartet auf Session…</span>
    </div>
    <div class="flashcard" id="flashcard">
      <div class="flashcard-status" id="card-status">Status: –</div>
      <div class="flashcard-topic" id="card-topic">Kein Thema</div>
      <div class="flashcard-front" id="card-front">Starte eine Session und klicke auf die Karte, um die Rückseite zu sehen.</div>
      <div class="flashcard-back hidden" id="card-back"></div>
      <div class="flashcard-sub" id="card-sub">Deck: – · Klick auf die Karte zum Umdrehen.</div>
    </div>
    <div class="learning-bottom">
      <div class="learning-meta">
        <div class="metrics">
          <div class="metric"><span id="l-count">0</span><span>Karten heute</span></div>
          <div class="metric"><span id="l-due">0</span><span>fällig</span></div>
          <div class="metric"><span id="l-overdue">0</span><span>überfällig</span></div>
          <div class="metric"><span id="l-progress">0%</span><span>Ziel-Fortschritt</span></div>
        </div>
      </div>
      <div class="diff-buttons">
        <button id="btn-new" class="diff-new small">New</button>
        <button id="btn-hard" class="diff-hard small">Hard</button>
        <button id="btn-easy" class="diff-easy small">Easy</button>
        <button id="btn-learned" class="diff-learned small">Learned</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-header-title">Statistiken · Zeit & Boxplot</div>
        <div class="section-title">Lernstatistiken</div>
      </div>
      <div class="tabs">
        <button id="tab-daily" class="active">Täglich</button>
        <button id="tab-weekly">Wöchentlich</button>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Zeitaufwand & Kartenaktivität</label>
        <div class="chart-box">
          <div class="chart-header">
            <span id="time-title">Aktivität (Tage)</span>
            <div class="legend">
              <div class="legend-item"><span class="legend-color" style="background:#22c55e"></span><span>Minuten</span></div>
              <div class="legend-item"><span class="legend-color" style="background:#38bdf8"></span><span>Karten</span></div>
            </div>
          </div>
          <svg id="time-chart"></svg>
        </div>
        <div style="margin-top:5px">
          <label>Gesamtfortschritt</label>
          <div class="metrics">
            <div class="metric"><span id="k-total-learned">0%</span><span>gelernt (gesamt)</span></div>
            <div class="metric"><span id="k-active-cards">0</span><span>aktive Karten (Filter)</span></div>
            <div class="metric"><span id="k-avg-min">0</span><span>Ø Min./Tag (7&nbsp;Tage)</span></div>
          </div>
        </div>
      </div>
      <div class="col">
        <label>Boxplot nach Themen</label>
        <div class="chart-box">
          <div class="chart-header">
            <span>Verteilung Lernstand & Aktivität</span>
            <div class="legend">
              <div class="legend-item"><span class="legend-color" style="background:#22c55e"></span><span>Lernstand (Box)</span></div>
              <div class="legend-item"><span class="legend-color" style="background:#38bdf8"></span><span>Aktivität (Punkt)</span></div>
            </div>
          </div>
          <svg id="boxplot-chart"></svg>
        </div>
        <div class="small" style="margin-top:4px">
          Jede Box repräsentiert ein Thema (alphabetisch sortiert). Die Boxhöhe steht für den Anteil gelernter Karten, der Punkt innerhalb der Box für die mediane Kartenaktivität in diesem Thema.
        </div>
      </div>
    </div>
  </section>
</div>

<script type="module">
let wasmExports=null;
const wasmBytes=new Uint8Array([
  0x00,0x61,0x73,0x6d,0x01,0x00,0x00,0x00,
  0x01,0x07,0x01,0x60,0x02,0x7f,0x7f,0x01,0x7f,
  0x03,0x02,0x01,0x00,
  0x07,0x07,0x01,0x03,0x61,0x64,0x64,0x00,0x00,
  0x0a,0x09,0x01,0x07,0x00,0x20,0x00,0x20,0x01,0x6a,0x0b
]);
WebAssembly.instantiate(wasmBytes,{}).then(res=>{wasmExports=res.instance.exports;}).catch(()=>{wasmExports=null;});

const STORAGE_KEY="anki_wasm_state_v1";
let state={
  decks:{},
  cards:{},
  goals:{},
  sessions:{},
  activeSessionId:null,
  statusFilters:{new:true,hard:true,easy:true,learned:true},
  stats:{events:[],topicActivity:{}}
};
let currentCardId=null;
let cardFront=true;
const $=id=>document.getElementById(id);

function todayStr(){return new Date().toISOString().slice(0,10);}
function diffDays(dStr){
  if(!dStr)return 0;
  const d=new Date(dStr);
  if(isNaN(d.getTime()))return 0;
  const now=new Date();const diff=(now-d)/86400000;
  return Math.floor(diff);
}
function randomId(prefix){return prefix+"_"+Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){}}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){const parsed=JSON.parse(raw);if(parsed&&typeof parsed==="object")state=parsed;}
  }catch(e){}
}
loadState();

function validateDeckJson(json,fname){
  const errors=[];
  const ctx=fname?(" ("+fname+")"):"";
  if(!json||typeof json!=="object"){
    errors.push("Datei"+ctx+": kein gültiges JSON-Objekt.");
    return{ok:false,errors};
  }
  if(typeof json.deckName!=="string"||json.deckName.trim()===""){
    errors.push("Datei"+ctx+": Feld 'deckName' fehlt oder ist leer.");
  }
  if(!Array.isArray(json.cards)||json.cards.length===0){
    errors.push("Datei"+ctx+": Feld 'cards' fehlt oder enthält keine Karten.");
  }
  const allowedStatus=new Set(["new","hard","easy","learned"]);
  const ids=new Set();
  const now=new Date();
  const maxDays=365;
  if(Array.isArray(json.cards)){
    json.cards.forEach((c,idx)=>{
      const pos="Karte "+(c&&c.id?("'"+c.id+"'"):"#"+(idx+1));
      if(!c||typeof c!=="object"){errors.push("Datei"+ctx+": "+pos+" ist kein gültiges Objekt.");return;}
      if(typeof c.id!=="string"||c.id.trim()===""){errors.push("Datei"+ctx+": "+pos+" ohne gültige 'id'.");}
      if(typeof c.front!=="string"||c.front.trim()===""){errors.push("Datei"+ctx+": "+pos+" ohne gültige 'front'.");}
      if(typeof c.back!=="string"||c.back.trim()===""){errors.push("Datei"+ctx+": "+pos+" ohne gültige 'back'.");}
      if(typeof c.id==="string"){
        if(ids.has(c.id)){errors.push("Datei"+ctx+": doppelte Karten-ID '"+c.id+"'.");}
        ids.add(c.id);
      }
      const sRaw=(c.status==null?"new":String(c.status)).toLowerCase();
      if(!allowedStatus.has(sRaw)){
        errors.push("Datei"+ctx+": "+pos+" mit unbekanntem Status '"+c.status+"'. Erlaubt: new, hard, easy, learned.");
      }
      if(c.lastReviewed!=null&&c.lastReviewed!==""){
        const d=new Date(c.lastReviewed);
        if(isNaN(d.getTime())){
          errors.push("Datei"+ctx+": "+pos+" mit ungültigem Datum 'lastReviewed'. Erwartet ISO-Format, z. B. 2024-01-10.");
        }else{
          const diffMs=d-now;
          const diffAbsDays=Math.abs((d-now)/86400000);
          if(diffMs>0){
            errors.push("Datei"+ctx+": "+pos+" mit Datum 'lastReviewed' in der Zukunft.");
          }
          if(diffAbsDays>maxDays){
            errors.push("Datei"+ctx+": "+pos+" mit Datum 'lastReviewed', das mehr als 1 Jahr von heute entfernt ist.");
          }
        }
      }
      const frontStr=String(c.front??"");
      const backStr=String(c.back??"");
      const maxCharsPerSide=300;
      const maxLinesPerSide=6;
      const frontLines=frontStr.split(/\r?\n/).length;
      const backLines=backStr.split(/\r?\n/).length;
      if(frontStr.length>maxCharsPerSide||backStr.length>maxCharsPerSide){
        errors.push("Datei"+ctx+": "+pos+" mit zu viel Text (max. "+maxCharsPerSide+" Zeichen pro Seite).");
      }
      if(frontLines>maxLinesPerSide||backLines>maxLinesPerSide){
        errors.push("Datei"+ctx+": "+pos+" mit zu vielen Zeilen (max. "+maxLinesPerSide+" Zeilen pro Seite).");
      }
    });
  }
  if(errors.length>0)return{ok:false,errors};
  return{ok:true,errors:[]};
}

function computeOverview(){
  const topics={};
  let total=0,newC=0,hard=0,easy=0,learned=0,due=0,overdue=0;
  Object.values(state.cards).forEach(c=>{
    total++;
    if(!topics[c.topic])topics[c.topic]={topic:c.topic,total:0,learned:0,new:0,hard:0,easy:0,due:0,overdue:0};
    const t=topics[c.topic];
    t.total++;
    const ds=diffDays(c.lastReviewed);
    if(c.status==="learned"){learned++;t.learned++;}
    else if(c.status==="hard"){
      hard++;t.hard++;
      if(ds>0&&ds<=7){due++;t.due++;}else if(ds>7){overdue++;t.overdue++;}
    }else if(c.status==="easy"){
      easy++;t.easy++;
      if(ds>0&&ds<=7){due++;t.due++;}else if(ds>7){overdue++;t.overdue++;}
    }else{
      newC++;t.new++;
    }
  });
  const topicArr=Object.values(topics).sort((a,b)=>a.topic.localeCompare(b.topic));
  let learnedPercent=0;
  if(total>0){
    const base=(learned*100)/total;
    const adj=wasmExports?wasmExports.add(0,0):0;
    learnedPercent=Math.min(100,Math.max(0,base+adj));
  }
  return{total,new:newC,hard,easy,learned,due,overdue,topics:topicArr,learnedPercent};
}

function computeGoalProgress(goalId){
  const goal=state.goals[goalId];if(!goal)return 0;
  let total=0,learned=0;
  Object.values(state.cards).forEach(c=>{
    if(goal.deckIds.includes(c.deckId)){total++;if(c.status==="learned")learned++;}
  });
  return total>0?Math.round(learned*100/total):0;
}

function activeFiltersSet(){
  const s=state.statusFilters;
  const res=[];for(const k in s){if(s[k])res.push(k);}
  return new Set(res);
}

function nextCardForSession(){
  const sessId=state.activeSessionId;
  if(!sessId)return null;
  const sess=state.sessions[sessId];if(!sess)return null;
  const goal=state.goals[sess.goalId];if(!goal)return null;
  const filters=activeFiltersSet();
  const pool=[];
  Object.values(state.cards).forEach(c=>{
    if(!goal.deckIds.includes(c.deckId))return;
    if(!filters.has(c.status))return;
    pool.push(c.id);
  });
  if(pool.length===0)return null;
  shuffle(pool);
  if(currentCardId && pool.length>1 && pool[0]===currentCardId){
    const idx=Math.floor(Math.random()*(pool.length));
    [pool[0],pool[idx]]=[pool[idx],pool[0]];
  }
  return pool[0];
}

function logEvent(date,minutes,cards){
  const ev={date,minutes:minutes||0,cards:cards||0};
  state.stats.events.push(ev);
}

function updateTopicActivity(topic,delta){
  if(!state.stats.topicActivity)state.stats.topicActivity={};
  state.stats.topicActivity[topic]=(state.stats.topicActivity[topic]||0)+delta;
}

function buildTimeSeries(mode){
  const map={};
  for(const e of state.stats.events){
    if(!e.date)continue;
    if(mode==="daily"){
      map[e.date]||(map[e.date]={minutes:0,cards:0});
      map[e.date].minutes+=e.minutes||0;
      map[e.date].cards+=e.cards||0;
    }else{
      const d=new Date(e.date);
      if(isNaN(d.getTime()))continue;
      const y=d.getFullYear();
      const oneJan=new Date(y,0,1);
      const day=Math.floor((d-oneJan)/86400000)+1;
      const week=Math.ceil(day/7);
      const key=y+"-KW"+week;
      map[key]||(map[key]={minutes:0,cards:0});
      map[key].minutes+=e.minutes||0;
      map[key].cards+=e.cards||0;
    }
  }
  const entries=Object.entries(map);
  entries.sort((a,b)=>a[0]<b[0]?1:-1);
  const maxItems=mode==="daily"?7:8;
  const trimmed=entries.slice(0,maxItems).reverse();
  return trimmed.map(([label,val])=>({label,minutes:val.minutes,cards:val.cards}));
}

function renderDecks(){
  const list=$("deck-list");
  const empty=$("deck-list-empty");
  list.innerHTML="";
  const decks=Object.values(state.decks);
  if(decks.length===0){empty.style.display="block";return;}else empty.style.display="none";
  decks.forEach(d=>{
    const div=document.createElement("div");
    div.className="item";
    const left=document.createElement("div");
    left.className="item-main";
    const t=document.createElement("div");
    t.className="item-title";
    t.textContent=d.name;
    const s=document.createElement("div");
    s.className="item-sub";
    s.textContent=d.cardIds.length+" Karten · "+Object.keys(d.topicCounts||{}).length+" Themen";
    left.appendChild(t);left.appendChild(s);
    const right=document.createElement("div");
    right.className="item-right";
    const span=document.createElement("span");
    span.className="small";
    span.textContent="id:"+d.id.slice(0,6);
    right.appendChild(span);
    div.appendChild(left);div.appendChild(right);
    list.appendChild(div);
  });
  $("deck-count").textContent=decks.length+" Decks";
}

function renderGoalDeckCheckboxes(){
  const cont=$("goal-decks");
  cont.innerHTML="";
  const decks=Object.values(state.decks);
  if(decks.length===0){
    cont.textContent="Noch keine Decks verfügbar.";
    return;
  }
  decks.forEach(d=>{
    const row=document.createElement("div");
    row.className="item";
    const label=document.createElement("label");
    label.className="small";
    const cb=document.createElement("input");
    cb.type="checkbox";cb.value=d.id;cb.style.marginRight="4px";
    label.appendChild(cb);
    label.appendChild(document.createTextNode(d.name));
    row.appendChild(label);
    cont.appendChild(row);
  });
}

function renderGoals(){
  const list=$("goal-list");
  const empty=$("goal-list-empty");
  const sel=$("session-goal");
  list.innerHTML="";sel.innerHTML='<option value="">Lernziel wählen…</option>';
  const goals=Object.values(state.goals);
  if(goals.length===0){empty.style.display="block";}else empty.style.display="none";
  goals.forEach(g=>{
    const div=document.createElement("div");
    div.className="item";
    const left=document.createElement("div");
    left.className="item-main";
    const t=document.createElement("div");
    t.className="item-title";
    t.textContent=g.name;
    const s=document.createElement("div");
    s.className="item-sub";
    const decks=g.deckIds.map(id=>state.decks[id]?.name||"?");
    const prog=computeGoalProgress(g.id);
    s.textContent=decks.join(", ")+" · "+prog+"% gelernt";
    left.appendChild(t);left.appendChild(s);
    const right=document.createElement("div");
    right.className="item-right";
    const del=document.createElement("button");
    del.textContent="×";del.className="small";
    del.onclick=()=>{delete state.goals[g.id];saveState();renderGoals();};
    right.appendChild(del);
    div.appendChild(left);div.appendChild(right);
    list.appendChild(div);
    const opt=document.createElement("option");
    opt.value=g.id;opt.textContent=g.name;
    sel.appendChild(opt);
  });
  $("goal-count").textContent=goals.length+" Lernziele";
}

function renderStatusChart(ov){
  const svg=$("status-chart");
  const w=svg.clientWidth||300,h=svg.clientHeight||130;
  svg.setAttribute("viewBox","0 0 "+w+" "+h);
  svg.innerHTML="";
  const topics=ov.topics;
  if(topics.length===0)return;
  const maxTotal=Math.max(...topics.map(t=>t.total));
  const barW=Math.max(10,(w-20)/topics.length-6);
  topics.forEach((t,idx)=>{
    const x=10+idx*(barW+6);
    const heightScale=(h-30)/maxTotal;
    let yBottom=h-15;
    const parts=[
      {v:t.new,color:"#38bdf8"},
      {v:t.due+t.hard,color:"#fb923c"},
      {v:t.easy,color:"#22c55e"},
      {v:t.learned,color:"#a855f7"}
    ];
    parts.forEach(p=>{
      if(!p.v)return;
      const bh=p.v*heightScale;
      const y=yBottom-bh;
      const rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x",x);
      rect.setAttribute("y",y);
      rect.setAttribute("width",barW);
      rect.setAttribute("height",bh);
      rect.setAttribute("fill",p.color);
      svg.appendChild(rect);
      yBottom=y;
    });
    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",x+barW/2);
    txt.setAttribute("y",h-4);
    txt.setAttribute("text-anchor","middle");
    txt.setAttribute("fill","#9ca3af");
    txt.setAttribute("font-size","9");
    txt.textContent=t.topic.slice(0,6);
    svg.appendChild(txt);
  });
}

function renderBoxplot(ov){
  const svg=$("boxplot-chart");
  const w=svg.clientWidth||300,h=svg.clientHeight||130;
  svg.setAttribute("viewBox","0 0 "+w+" "+h);
  svg.innerHTML="";
  const topics=ov.topics;
  if(topics.length===0)return;
  const ta=state.stats.topicActivity||{};
  const data=topics.map(t=>{
    const learnedPct=t.total? (t.learned*100/t.total):0;
    const act=ta[t.topic]||0;
    return{topic:t.topic,learnedPct,activity:act};
  }).sort((a,b)=>a.topic.localeCompare(b.topic));
  const maxPct=100;
  const maxAct=Math.max(1,...data.map(d=>d.activity));
  const boxW=Math.max(8,(w-20)/data.length-6);
  data.forEach((d,idx)=>{
    const x=10+idx*(boxW+6);
    const base=h-18;
    const scale=(h-30)/maxPct;
    const q1=d.learnedPct*0.5;
    const q3=d.learnedPct;
    const median=d.learnedPct*0.75;
    const yQ1=base-q1*scale;
    const yQ3=base-q3*scale;
    const yMed=base-median*scale;
    const box=document.createElementNS("http://www.w3.org/2000/svg","rect");
    box.setAttribute("x",x);
    box.setAttribute("y",yQ3);
    box.setAttribute("width",boxW);
    box.setAttribute("height",Math.max(2,yQ1-yQ3));
    box.setAttribute("fill","#16a34a");
    box.setAttribute("fill-opacity","0.45");
    box.setAttribute("stroke","#22c55e");
    svg.appendChild(box);
    const med=document.createElementNS("http://www.w3.org/2000/svg","line");
    med.setAttribute("x1",x);
    med.setAttribute("x2",x+boxW);
    med.setAttribute("y1",yMed);
    med.setAttribute("y2",yMed);
    med.setAttribute("stroke","#bbf7d0");
    med.setAttribute("stroke-width","1");
    svg.appendChild(med);
    const actY=base-(d.activity/maxAct)*(h-30);
    const circ=document.createElementNS("http://www.w3.org/2000/svg","circle");
    circ.setAttribute("cx",x+boxW/2);
    circ.setAttribute("cy",actY);
    circ.setAttribute("r","2.3");
    circ.setAttribute("fill","#38bdf8");
    svg.appendChild(circ);
    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",x+boxW/2);
    txt.setAttribute("y",h-5);
    txt.setAttribute("text-anchor","middle");
    txt.setAttribute("fill","#9ca3af");
    txt.setAttribute("font-size","8");
    txt.textContent=d.topic.slice(0,6);
    svg.appendChild(txt);
  });
}

function renderOverview(){
  const ov=computeOverview();
  $("m-total").textContent=ov.total;
  $("m-topics").textContent=ov.topics.length;
  $("m-due").textContent=ov.due;
  $("m-overdue").textContent=ov.overdue;
  $("m-learned-bar").style.width=ov.learnedPercent.toFixed(1)+"%";
  $("hdr-total-cards").textContent=ov.total;
  $("hdr-learned").textContent=ov.learnedPercent.toFixed(1)+"%";
  const filters=activeFiltersSet();
  let activeCards=0;
  Object.values(state.cards).forEach(c=>{if(filters.has(c.status))activeCards++;});
  $("k-active-cards").textContent=activeCards;
  $("k-total-learned").textContent=ov.learnedPercent.toFixed(1)+"%";
  renderStatusChart(ov);
  renderBoxplot(ov);
}

function renderTimeChart(mode){
  const data=buildTimeSeries(mode);
  $("time-title").textContent=mode==="daily"?"Aktivität (Tage)":"Aktivität (Wochen)";
  const svg=$("time-chart");
  const w=svg.clientWidth||300,h=svg.clientHeight||130;
  svg.setAttribute("viewBox","0 0 "+w+" "+h);
  svg.innerHTML="";
  if(data.length===0)return;
  const maxMin=Math.max(1,...data.map(d=>d.minutes));
  const maxCards=Math.max(1,...data.map(d=>d.cards));
  const barW=Math.max(10,(w-20)/data.length-6);
  data.forEach((d,idx)=>{
    const x=10+idx*(barW+6);
    const base=h-18;
    const hMin=(d.minutes/maxMin)*(h-35);
    const hCards=(d.cards/maxCards)*(h-35);
    const r1=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r1.setAttribute("x",x);
    r1.setAttribute("y",base-hMin);
    r1.setAttribute("width",barW/2-1);
    r1.setAttribute("height",hMin);
    r1.setAttribute("fill","#22c55e");
    r1.setAttribute("fill-opacity","0.75");
    svg.appendChild(r1);
    const r2=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r2.setAttribute("x",x+barW/2+1);
    r2.setAttribute("y",base-hCards);
    r2.setAttribute("width",barW/2-1);
    r2.setAttribute("height",hCards);
    r2.setAttribute("fill","#38bdf8");
    r2.setAttribute("fill-opacity","0.75");
    svg.appendChild(r2);
    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",x+barW/2);
    txt.setAttribute("y",h-5);
    txt.setAttribute("text-anchor","middle");
    txt.setAttribute("fill","#9ca3af");
    txt.setAttribute("font-size","8");
    txt.textContent=mode==="daily"?d.label.slice(5):d.label.split("-")[1];
    svg.appendChild(txt);
  });
  let todayMin=0;
  data.forEach(d=>{if(d.label===todayStr())todayMin=d.minutes;});
  $("hdr-time-today").textContent=Math.round(todayMin);
  const last7=buildTimeSeries("daily");
  let sum=0;last7.forEach(d=>sum+=d.minutes);
  $("k-avg-min").textContent=(last7.length? (sum/last7.length).toFixed(1):"0");
}

let sessionTimer=null;
function updateSessionUI(){
  const sessId=state.activeSessionId;
  if(!sessId){
    $("session-info").textContent="Keine aktive Session.";
    $("learning-badge").textContent="Wartet auf Session…";
    $("btn-session-toggle").textContent="Session starten";
    $("s-min").textContent="0";
    $("s-cards").textContent="0";
    $("s-rate").textContent="0";
    $("s-progress").style.width="0%";
    return;
  }
  const s=state.sessions[sessId];if(!s){state.activeSessionId=null;return;}
  const min=Math.floor((s.elapsedMs||0)/60000);
  $("s-min").textContent=min;
  $("s-cards").textContent=s.cardsReviewed||0;
  const rate=min>0?Math.round((s.cardsReviewed||0)*10/min):0;
  $("s-rate").textContent=rate;
  $("session-info").textContent="Aktive Session für Lernziel: "+(state.goals[s.goalId]?.name||"?");
  $("learning-badge").textContent="Aktive Session";
  const prog=computeGoalProgress(s.goalId);
  $("s-progress").style.width=prog+"%";
  $("l-progress").textContent=prog+"%";
}

function startSession(goalId){
  if(!goalId)return;
  const id=randomId("sess");
  state.sessions[id]={id,goalId,active:true,startMs:Date.now(),elapsedMs:0,cardsReviewed:0};
  state.activeSessionId=id;
  if(sessionTimer)clearInterval(sessionTimer);
  let last=Date.now();
  sessionTimer=setInterval(()=>{
    const now=Date.now();
    const delta=now-last;last=now;
    const s=state.sessions[state.activeSessionId];if(!s)return;
    s.elapsedMs+=(delta||0);
    saveState();
    updateSessionUI();
  },1000);
  saveState();
  updateSessionUI();
  pickNextCard();
}

function stopSession(){
  const id=state.activeSessionId;
  if(!id)return;
  const s=state.sessions[id];
  if(s){
    s.active=false;
    const mins=(s.elapsedMs||0)/60000;
    if(mins>0||s.cardsReviewed>0)logEvent(todayStr(),mins,s.cardsReviewed||0);
  }
  state.activeSessionId=null;
  if(sessionTimer)clearInterval(sessionTimer);
  sessionTimer=null;
  saveState();
  updateSessionUI();
  renderTimeChart(currentTimeMode);
}

function showCard(card){
  if(!card){
    $("card-topic").textContent="Kein Thema";
    $("card-front").textContent="Keine passenden Karten für diese Filter oder dieses Lernziel.";
    $("card-back").classList.add("hidden");
    $("card-back").textContent="";
    $("card-sub").textContent="Passe Filter oder Session-Auswahl an.";
    $("card-status").textContent="Status: –";
    return;
  }
  $("card-topic").textContent=card.topic||"–";
  $("card-front").textContent=card.front;
  $("card-back").textContent=card.back;
  $("card-back").classList.add("hidden");
  $("card-status").textContent="Status: "+card.status;
  $("card-sub").textContent="Deck: "+(state.decks[card.deckId]?.name||"–")+" · Klick auf die Karte zum Umdrehen.";
  cardFront=true;
}

function pickNextCard(){
  const id=nextCardForSession();
  currentCardId=id;
  const card=id?state.cards[id]:null;
  showCard(card);
  updateLearningMeta();
}

function updateLearningMeta(){
  const ov=computeOverview();
  $("l-count").textContent=state.stats.events.filter(e=>e.date===todayStr()).reduce((a,e)=>a+e.cards,0);
  $("l-due").textContent=ov.due;
  $("l-overdue").textContent=ov.overdue;
}

function rateCurrent(status){
  if(!currentCardId)return;
  const card=state.cards[currentCardId];
  if(!card)return;
  card.status=status;
  card.lastReviewed=todayStr();
  const sessId=state.activeSessionId;
  if(sessId&&state.sessions[sessId]){
    state.sessions[sessId].cardsReviewed=(state.sessions[sessId].cardsReviewed||0)+1;
  }
  logEvent(todayStr(),0,1);
  updateTopicActivity(card.topic,1);
  saveState();
  renderOverview();
  renderTimeChart(currentTimeMode);
  updateSessionUI();
  pickNextCard();
}

$("flashcard").addEventListener("click",()=>{
  const back=$("card-back");
  back.classList.toggle("hidden");
  cardFront=!back.classList.contains("hidden");
});

Array.from(document.getElementsByClassName("status-filter")).forEach(cb=>{
  cb.addEventListener("change",()=>{
    state.statusFilters[cb.value]=cb.checked;
    saveState();
    renderOverview();
    renderTimeChart(currentTimeMode);
    updateSessionUI();
    pickNextCard();
  });
});

$("btn-clear").addEventListener("click",()=>{
  if(!confirm("Alle lokal gespeicherten Decks, Lernziele und Statistiken löschen?"))return;
  state={decks:{},cards:{},goals:{},sessions:{},activeSessionId:null,statusFilters:{new:true,hard:true,easy:true,learned:true},stats:{events:[],topicActivity:{}}};
  currentCardId=null;
  if(sessionTimer)clearInterval(sessionTimer);
  sessionTimer=null;
  saveState();
  $("import-status").textContent="Alle Daten gelöscht.";
  renderDecks();renderGoalDeckCheckboxes();renderGoals();renderOverview();renderTimeChart(currentTimeMode);updateSessionUI();pickNextCard();
});

$("deck-file").addEventListener("change",ev=>{
  const files=Array.from(ev.target.files||[]);
  if(files.length===0)return;
  let imported=0,failed=0;
  const failedDetails=[];
  const promises=files.map(f=>f.text().then(txt=>{
    try{
      const json=JSON.parse(txt);
      const validation=validateDeckJson(json,f.name);
      if(!validation.ok){
        failed++;
        if(validation.errors.length>0)failedDetails.push(validation.errors[0]);
        return;
      }
      const deckId=randomId("deck");
      const cardIds=[];
      const topicCounts={};
      json.cards.forEach(c=>{
        const rawStatus=(c.status==null?"new":String(c.status)).toLowerCase();
        const status=rawStatus==="hard"?"hard":rawStatus==="easy"?"easy":rawStatus==="learned"?"learned":"new";
        const topic=(c.topic&&String(c.topic).trim())?String(c.topic).trim():"Allgemein";
        const cid=deckId+"::"+c.id;
        state.cards[cid]={
          id:cid,
          front:String(c.front),
          back:String(c.back),
          topic,
          status,
          lastReviewed:c.lastReviewed||null,
          deckId
        };
        cardIds.push(cid);
        topicCounts[topic]=(topicCounts[topic]||0)+1;
      });
      state.decks[deckId]={id:deckId,name:String(json.deckName).trim(),cardIds,topicCounts};
      imported++;
    }catch(e){
      failed++;
      failedDetails.push("Datei '"+f.name+"': ungültiges JSON oder Struktur.");
    }
  }).catch(()=>{
    failed++;
    failedDetails.push("Datei '"+f.name+"': konnte nicht gelesen werden.");
  }));
  Promise.all(promises).then(()=>{
    let msg="Importiert: "+imported+" Deck(s)";
    if(failed>0)msg+=", abgelehnt: "+failed;
    if(failedDetails.length>0){
      const short=failedDetails.slice(0,3).join(" | ");
      msg+=" – Hinweise: "+short;
      $("import-status").title=failedDetails.join(" · ");
    }else{
      $("import-status").title="";
    }
    $("import-status").textContent=msg;
    saveState();
    renderDecks();renderGoalDeckCheckboxes();renderOverview();renderTimeChart(currentTimeMode);pickNextCard();
  });
});

$("btn-add-goal").addEventListener("click",()=>{
  const name=$("goal-name").value.trim();
  if(!name){$("goal-status").textContent="Name fehlt.";return;}
  const deckIds=[];
  Array.from($("goal-decks").querySelectorAll("input[type=checkbox]")).forEach(cb=>{if(cb.checked)deckIds.push(cb.value);});
  if(deckIds.length===0){$("goal-status").textContent="Mindestens ein Deck wählen.";return;}
  const id=randomId("goal");
  state.goals[id]={id,name,deckIds};
  $("goal-name").value="";
  $("goal-status").textContent="Lernziel gespeichert.";
  saveState();
  renderGoals();
});

$("btn-session-toggle").addEventListener("click",()=>{
  if(state.activeSessionId){stopSession();$("btn-session-toggle").textContent="Session starten";return;}
  const goalId=$("session-goal").value;
  if(!goalId){alert("Bitte ein Lernziel auswählen.");return;}
  $("btn-session-toggle").textContent="Session stoppen";
  startSession(goalId);
});

$("btn-new").addEventListener("click",()=>rateCurrent("new"));
$("btn-hard").addEventListener("click",()=>rateCurrent("hard"));
$("btn-easy").addEventListener("click",()=>rateCurrent("easy"));
$("btn-learned").addEventListener("click",()=>rateCurrent("learned"));

let currentTimeMode="daily";
$("tab-daily").addEventListener("click",()=>{
  currentTimeMode="daily";
  $("tab-daily").classList.add("active");
  $("tab-weekly").classList.remove("active");
  renderTimeChart(currentTimeMode);
});
$("tab-weekly").addEventListener("click",()=>{
  currentTimeMode="weekly";
  $("tab-weekly").classList.add("active");
  $("tab-daily").classList.remove("active");
  renderTimeChart(currentTimeMode);
});

renderDecks();
renderGoalDeckCheckboxes();
renderGoals();
renderOverview();
renderTimeChart(currentTimeMode);
updateSessionUI();
pickNextCard();
</script>
</body>
</html>