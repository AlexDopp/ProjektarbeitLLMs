<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Anki Lern-App – Lokal (HTML + Wasm)</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
}
header {
  background: #2c3e50;
  color: #fff;
  padding: 12px 20px;
}
main {
  padding: 20px;
}
section {
  background: #fff;
  padding: 16px;
  margin-bottom: 16px;
  border-radius: 6px;
}
button {
  margin: 4px;
}
.card {
  border: 1px solid #ccc;
  padding: 20px;
  min-height: 100px;
  margin-bottom: 10px;
}
.hidden {
  display: none;
}
.boxplot {
  display: flex;
  align-items: flex-end;
  height: 120px;
  gap: 6px;
}
.box {
  width: 20px;
}
.legend {
  display: flex;
  gap: 12px;
  font-size: 12px;
}
.legend span {
  display: inline-block;
  width: 12px;
  height: 12px;
}
</style>
</head>

<body>

<header>
  <h1>Anki Lern-App (lokal, ohne Libraries)</h1>
</header>

<main>

<section>
  <h2>1. Deck importieren</h2>
  <input type="file" id="importFile">
  <div id="importError" style="color:red;"></div>
</section>

<section>
  <h2>2. Lernziele</h2>
  <input id="goalName" placeholder="Neues Lernziel">
  <button onclick="UI.addGoal()">Hinzufügen</button>
  <ul id="goalList"></ul>
</section>

<section>
  <h2>3. Deck-Übersicht</h2>
  <div id="deckStats"></div>
</section>

<section>
  <h2>4. Lernsession</h2>
  <button onclick="UI.startSession()">Session starten</button>
  <button onclick="UI.stopSession()">Session stoppen</button>

  <div id="cardView" class="card hidden"></div>

  <button id="flipBtn" class="hidden" onclick="UI.flipCard()">Karte umdrehen</button>

  <div id="ratingButtons" class="hidden">
    <button onclick="UI.rateCard('new')">Neu</button>
    <button onclick="UI.rateCard('hard')">Schwer</button>
    <button onclick="UI.rateCard('easy')">Leicht</button>
    <button onclick="UI.rateCard('learned')">Gelernt</button>
  </div>
</section>

<section>
  <h2>5. Lernfortschritt</h2>
  <div id="progressView"></div>
</section>

<section>
  <h2>6–7. Aktivität & Boxplot</h2>
  <div id="boxplot" class="boxplot"></div>
  <div class="legend">
    <div><span style="background:#3498db"></span> Thema A</div>
    <div><span style="background:#2ecc71"></span> Thema B</div>
  </div>
</section>

</main>

<!-- =======================
     Minimal gültiges Wasm
     (keine Memory-Sektion)
======================= -->
<script>
const wasmBytes = new Uint8Array([
  0x00,0x61,0x73,0x6D, // \0asm
  0x01,0x00,0x00,0x00  // version
]);

async function initWasm() {
  try {
    await WebAssembly.instantiate(wasmBytes);
    console.log("Wasm initialisiert");
  } catch (e) {
    console.error("Wasm Fehler:", e);
  }
}
initWasm();
</script>

<script>
/* =======================
   State & Persistenz
======================= */
const State = {
  decks: [],
  goals: [],
  session: {
    active: false,
    start: null,
    cardsReviewed: 0
  }
};

function saveState() {
  localStorage.setItem("ankiState", JSON.stringify(State));
}
function loadState() {
  const s = localStorage.getItem("ankiState");
  if (s) Object.assign(State, JSON.parse(s));
}
loadState();

/* =======================
   UI Controller
======================= */
const UI = {
  currentCard: null,
  side: "front",

  addGoal() {
    const name = document.getElementById("goalName").value.trim();
    if (!name) return;
    State.goals.push({ name, decks: [] });
    saveState();
    UI.renderGoals();
  },

  renderGoals() {
    const ul = document.getElementById("goalList");
    ul.innerHTML = "";
    State.goals.forEach(g => {
      const li = document.createElement("li");
      li.textContent = g.name;
      ul.appendChild(li);
    });
  },

  startSession() {
    const cards = State.decks.flatMap(d => d.cards);
    if (!cards.length) return;
    State.session.active = true;
    State.session.start = Date.now();
    UI.nextCard();
  },

  stopSession() {
    State.session.active = false;
    UI.hideCardUI();
    saveState();
  },

  nextCard() {
    const cards = State.decks.flatMap(d => d.cards);
    UI.currentCard = cards[Math.floor(Math.random() * cards.length)];
    UI.side = "front";

    const view = document.getElementById("cardView");
    view.textContent = UI.currentCard.front;
    view.classList.remove("hidden");

    document.getElementById("flipBtn").classList.remove("hidden");
    document.getElementById("ratingButtons").classList.add("hidden");
  },

  flipCard() {
    if (!UI.currentCard) return;
    const view = document.getElementById("cardView");

    if (UI.side === "front") {
      view.textContent = UI.currentCard.back;
      UI.side = "back";
      document.getElementById("ratingButtons").classList.remove("hidden");
    }
  },

  rateCard(status) {
    UI.currentCard.status = status;
    UI.currentCard.lastReviewed = new Date().toISOString().slice(0, 10);
    State.session.cardsReviewed++;
    saveState();
    UI.renderProgress();
    UI.nextCard();
  },

  hideCardUI() {
    document.getElementById("cardView").classList.add("hidden");
    document.getElementById("flipBtn").classList.add("hidden");
    document.getElementById("ratingButtons").classList.add("hidden");
  },

  renderProgress() {
    const cards = State.decks.flatMap(d => d.cards);
    const learned = cards.filter(c => c.status === "learned").length;
    const percent = cards.length
      ? ((learned / cards.length) * 100).toFixed(1)
      : "0.0";
    document.getElementById("progressView").textContent =
      `Gesamtfortschritt: ${percent}%`;
  }
};

/* =======================
   Import
======================= */
document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      if (!json.deckName || !Array.isArray(json.cards)) {
        throw new Error("Ungültiges Deck-Format");
      }
      State.decks.push(json);
      saveState();
      UI.renderProgress();
    } catch (err) {
      document.getElementById("importError").textContent = err.message;
    }
  };
  reader.readAsText(file);
});

/* Initial Render */
UI.renderGoals();
UI.renderProgress();
</script>

</body>
</html>
