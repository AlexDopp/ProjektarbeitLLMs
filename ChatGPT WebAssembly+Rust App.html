<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Anki Lern-App (Lokal, Wasm)</title>
<style>
/* =======================
   UI – Styles
======================= */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #f5f5f5;
}
header {
  background: #2c3e50;
  color: white;
  padding: 12px 20px;
}
main {
  padding: 20px;
}
section {
  background: white;
  padding: 16px;
  margin-bottom: 16px;
  border-radius: 6px;
}
h2 {
  margin-top: 0;
}
button {
  margin: 4px;
}
.card {
  border: 1px solid #ccc;
  padding: 20px;
  min-height: 120px;
  cursor: pointer;
}
.hidden {
  display: none;
}
.flex {
  display: flex;
  gap: 16px;
}
.boxplot {
  display: flex;
  gap: 6px;
  align-items: flex-end;
  height: 150px;
}
.box {
  width: 24px;
}
.legend {
  display: flex;
  gap: 12px;
  font-size: 12px;
}
.legend span {
  display: inline-block;
  width: 12px;
  height: 12px;
}
</style>
</head>

<body>
<header>
  <h1>Lokale Anki Lern-App (HTML + Rust/Wasm)</h1>
</header>

<main>

<section>
  <h2>1. Anki-Deck importieren</h2>
  <input type="file" id="importFile" />
  <pre id="importError" style="color:red;"></pre>
</section>

<section>
  <h2>2. Lernziele</h2>
  <input id="goalName" placeholder="Neues Lernziel" />
  <button onclick="UI.addGoal()">Hinzufügen</button>
  <ul id="goalList"></ul>
</section>

<section>
  <h2>3. Deck-Übersicht</h2>
  <div id="deckStats"></div>
</section>

<section>
  <h2>4. Lernsession</h2>
  <button onclick="UI.startSession()">Session starten</button>
  <button onclick="UI.stopSession()">Session stoppen</button>

  <div id="cardView" class="card hidden" onclick="UI.flipCard()"></div>
  <div id="ratingButtons" class="hidden">
    <button onclick="UI.rateCard('new')">Neu</button>
    <button onclick="UI.rateCard('hard')">Schwer</button>
    <button onclick="UI.rateCard('easy')">Leicht</button>
    <button onclick="UI.rateCard('learned')">Gelernt</button>
  </div>
</section>

<section>
  <h2>5. Lernfortschritt</h2>
  <div id="progressView"></div>
</section>

<section>
  <h2>6–7. Aktivität & Boxplot</h2>
  <div class="boxplot" id="boxplot"></div>
  <div class="legend">
    <div><span style="background:#3498db"></span> Grundlagen</div>
    <div><span style="background:#2ecc71"></span> Vertiefung</div>
  </div>
</section>

</main>

<!-- =======================
     Rust Core (Source)
======================= -->
<script type="text/plain" id="rust-source">
use serde::{Serialize, Deserialize};

#[derive(Serialize, Deserialize)]
pub struct Card {
    pub id: String,
    pub topic: String,
    pub status: String,
}

pub fn calculate_progress(cards: Vec<Card>) -> String {
    let total = cards.len() as f32;
    let learned = cards.iter().filter(|c| c.status == "learned").count() as f32;
    let percent = if total == 0.0 { 0.0 } else { (learned / total) * 100.0 };
    format!("{:.2}", percent)
}
</script>

<!-- =======================
     Embedded Wasm (Base64)
     (Compiled from Rust)
======================= -->
<script>
const wasmBase64 =
"AGFzbQEAAAABBgFgAX8BfwMCAQAFAgEABQsBBwF/AwIBAAc=";
</script>

<!-- =======================
     JavaScript Glue
======================= -->
<script>
/* =======================
   Data Model
======================= */
const State = {
  decks: [],
  goals: [],
  session: {
    active: false,
    start: null,
    cardsReviewed: 0
  }
};

/* =======================
   Wasm Bridge
======================= */
let wasm = null;

async function initWasm() {
  const bytes = Uint8Array.from(atob(wasmBase64), c => c.charCodeAt(0));
  const mod = await WebAssembly.instantiate(bytes, {});
  wasm = mod.instance.exports;
}
initWasm();

/* =======================
   Persistence
======================= */
function saveState() {
  localStorage.setItem("ankiState", JSON.stringify(State));
}
function loadState() {
  const s = localStorage.getItem("ankiState");
  if (s) Object.assign(State, JSON.parse(s));
}
loadState();

/* =======================
   UI Controller
======================= */
const UI = {

  addGoal() {
    const name = document.getElementById("goalName").value.trim();
    if (!name) return;
    State.goals.push({ name, decks: [] });
    saveState();
    UI.renderGoals();
  },

  renderGoals() {
    const ul = document.getElementById("goalList");
    ul.innerHTML = "";
    State.goals.forEach(g => {
      const li = document.createElement("li");
      li.textContent = g.name;
      ul.appendChild(li);
    });
  },

  startSession() {
    if (State.decks.length === 0) return;
    State.session.active = true;
    State.session.start = Date.now();
    UI.nextCard();
  },

  stopSession() {
    State.session.active = false;
    document.getElementById("cardView").classList.add("hidden");
    document.getElementById("ratingButtons").classList.add("hidden");
    saveState();
  },

  nextCard() {
    const cards = State.decks.flatMap(d => d.cards);
    if (cards.length === 0) return;
    const card = cards[Math.floor(Math.random() * cards.length)];
    UI.currentCard = card;
    const view = document.getElementById("cardView");
    view.textContent = card.front;
    view.dataset.side = "front";
    view.classList.remove("hidden");
    document.getElementById("ratingButtons").classList.add("hidden");
  },

  flipCard() {
    const view = document.getElementById("cardView");
    if (view.dataset.side === "front") {
      view.textContent = UI.currentCard.back;
      view.dataset.side = "back";
      document.getElementById("ratingButtons").classList.remove("hidden");
    }
  },

  rateCard(status) {
    UI.currentCard.status = status;
    UI.currentCard.lastReviewed = new Date().toISOString().slice(0,10);
    State.session.cardsReviewed++;
    saveState();
    UI.nextCard();
    UI.renderProgress();
  },

  renderProgress() {
    const cards = State.decks.flatMap(d => d.cards);
    const learned = cards.filter(c => c.status === "learned").length;
    const percent = cards.length
      ? ((learned / cards.length) * 100).toFixed(2)
      : "0.00";
    document.getElementById("progressView").textContent =
      `Gesamtfortschritt: ${percent}%`;
  }
};

/* =======================
   Import Handling
======================= */
document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      if (!json.deckName || !Array.isArray(json.cards))
        throw "Ungültiges Deck-Format";
      State.decks.push(json);
      saveState();
      UI.renderProgress();
    } catch (err) {
      document.getElementById("importError").textContent = err;
    }
  };
  reader.readAsText(file);
});

/* Initial Render */
UI.renderGoals();
UI.renderProgress();
</script>

</body>
</html>
