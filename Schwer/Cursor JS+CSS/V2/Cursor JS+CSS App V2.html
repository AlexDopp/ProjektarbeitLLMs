<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Anki Lernfortschritt ‚Äì Lokale Web-App</title>
  <style>
    :root {
      --bg: #0f172a; --bg-alt: #020617; --card-bg: #020617; --card-border: #1e293b;
      --accent: #38bdf8; --accent-soft: rgba(56,189,248,0.15); --accent-strong: #0ea5e9;
      --danger: #f97373; --text: #e5e7eb; --text-muted: #9ca3af; --text-soft: #6b7280;
      --success: #22c55e; --warning: #facc15; --info: #4ade80;
      --radius-lg: 12px; --radius-md: 8px; --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.9); --shadow-subtle: 0 8px 20px rgba(15,23,42,0.7);
      --border-subtle: 1px solid rgba(148,163,184,0.15);
      --transition-fast: 0.16s ease-out; --transition-med: 0.22s ease-out;
      --font-sans: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:24px;
      background:radial-gradient(circle at top left,#1f2937 0,#020617 50%,#000 100%);
      color:var(--text);font-family:var(--font-sans);-webkit-font-smoothing:antialiased;
    }
    .app-shell{
      max-width:1220px;margin:0 auto;
      background:radial-gradient(circle at top left,rgba(56,189,248,.08),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(34,197,94,.06),transparent 55%),
                 rgba(15,23,42,.98);
      border-radius:24px;padding:20px 22px 26px;box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.2);backdrop-filter:blur(24px);
    }
    header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:18px;gap:16px;
    }
    header .title-block{display:flex;align-items:center;gap:14px}
    .icon-circle{
      width:40px;height:40px;border-radius:16px;
      background:radial-gradient(circle at 30% 20%,#38bdf8 0,transparent 55%),
                 radial-gradient(circle at 70% 80%,#22c55e 0,transparent 60%),#020617;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 28px rgba(56,189,248,.45);
      border:1px solid rgba(148,163,184,.4);font-size:18px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.02em;display:flex;align-items:baseline;gap:8px}
    h1 span.sub{
      font-size:12px;color:var(--text-soft);font-weight:400;
      text-transform:uppercase;letter-spacing:.16em;
    }
    header .meta{text-align:right;font-size:11px;color:var(--text-muted)}
    header .pill{
      display:inline-flex;align-items:center;gap:6px;padding:3px 9px;
      border-radius:999px;background:rgba(15,118,110,.3);
      border:1px solid rgba(34,197,94,.5);color:#bbf7d0;font-size:11px;
    }
    header .pill-dot{
      width:7px;height:7px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.9);
    }
    header .meta>div:last-child{margin-top:4px}
    main{display:grid;grid-template-columns:1.5fr 1.2fr;gap:18px}
    @media(max-width:960px){
      main{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start}
      header .meta{text-align:left}
    }
    .panel{
      background:radial-gradient(circle at top left,rgba(15,23,42,.9),rgba(15,23,42,.96));
      border-radius:var(--radius-lg);padding:14px 14px 16px;
      border:var(--border-subtle);box-shadow:var(--shadow-subtle);
      position:relative;overflow:hidden;
    }
    .panel::before{
      content:"";position:absolute;inset:0;
      background:radial-gradient(circle at top right,rgba(56,189,248,.08),transparent 55%);
      opacity:.7;pointer-events:none;
    }
    .panel-inner{position:relative;z-index:1}
    .panel-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:6px;gap:8px}
    .panel-title{
      font-size:14px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;
      color:#e5e7eb;display:flex;align-items:center;gap:8px;
    }
    .panel-title-pill{
      font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--text-soft);
    }
    .panel-description{margin:0;font-size:12px;color:var(--text-soft)}
    label{
      font-size:11px;text-transform:uppercase;letter-spacing:.16em;
      color:var(--text-soft);margin-bottom:5px;display:inline-block;
    }
    input[type="text"],textarea,select{
      width:100%;padding:7px 9px;border-radius:7px;
      border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.85);
      color:var(--text);font-size:13px;outline:none;
      transition:border-color .16s ease-out,box-shadow .16s ease-out,background .16s ease-out,transform .08s ease-out;
    }
    input[type="text"]:focus,textarea:focus,select:focus{
      border-color:var(--accent-strong);box-shadow:0 0 0 1px rgba(56,189,248,.45);background:rgba(15,23,42,.98);
    }
    textarea{min-height:50px;resize:vertical}
    .field-row{display:flex;gap:8px;align-items:flex-end}
    .field-row>*{flex:1}
    button{
      border-radius:999px;border:none;padding:7px 13px;font-size:12px;font-weight:500;
      letter-spacing:.05em;text-transform:uppercase;cursor:pointer;
      transition:background .22s ease-out,transform .08s ease-out,box-shadow .22s ease-out,border-color .22s ease-out;
      display:inline-flex;align-items:center;gap:6px;white-space:nowrap;
    }
    button:active{transform:translateY(1px) scale(.99);box-shadow:none}
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#0b1120;box-shadow:0 12px 25px rgba(56,189,248,.6);
      border:1px solid rgba(191,219,254,.75);
    }
    .btn-primary:hover{background:linear-gradient(135deg,#7dd3fc,#38bdf8)}
    .btn-ghost{
      background:rgba(15,23,42,.8);color:var(--text-muted);
      border:1px solid rgba(148,163,184,.55);
    }
    .btn-ghost:hover{background:rgba(15,23,42,.95);color:var(--text);border-color:var(--accent)}
    .btn-pill-sm{padding:4px 10px;font-size:11px}
    input[type="file"]{font-size:12px;color:var(--text-muted)}
    input[type="file"]::file-selector-button{
      border:none;background:rgba(15,23,42,.9);color:var(--text-muted);
      padding:6px 10px;margin-right:10px;border-radius:999px;cursor:pointer;
      border:1px solid rgba(148,163,184,.4);font-size:11px;letter-spacing:.08em;text-transform:uppercase;
    }
    input[type="file"]::file-selector-button:hover{border-color:var(--accent);color:var(--text)}
    .stat-pill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
      border-radius:999px;background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.45);font-size:11px;color:var(--text-muted);
      margin-right:6px;margin-bottom:4px;
    }
    .stat-pill span.value{font-weight:600;color:#f9fafb}
    .stat-pill--accent{border-color:rgba(56,189,248,.8);color:#e0f2fe;background:rgba(8,47,73,.9)}
    .stat-pill--success{border-color:rgba(34,197,94,.8);color:#bbf7d0;background:rgba(5,46,22,.9)}
    .stat-pill-dot{width:7px;height:7px;border-radius:999px;background:var(--accent)}
    .deck-list,.goal-list{
      margin:6px 0 0;padding:0;list-style:none;max-height:148px;overflow-y:auto;
      border-radius:9px;border:1px solid rgba(15,23,42,.7);
      background:radial-gradient(circle at top,rgba(15,23,42,.9),rgba(15,23,42,.98));
    }
    .deck-list-item,.goal-list-item{
      padding:7px 9px;display:grid;grid-template-columns:1.6fr 1fr;
      gap:6px;font-size:12px;border-bottom:1px solid rgba(15,23,42,.95);
    }
    .deck-list-item:last-child,.goal-list-item:last-child{border-bottom:none}
    .deck-list-item:hover,.goal-list-item:hover{background:rgba(15,23,42,.98)}
    .deck-name{font-weight:500;color:#e5e7eb}
    .deck-meta,.goal-meta{font-size:11px;color:var(--text-soft)}
    .deck-topic-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
    .chip{
      font-size:10px;border-radius:999px;padding:2px 7px;
      border:1px solid rgba(148,163,184,.4);background:rgba(15,23,42,.9);
      color:var(--text-soft);display:inline-flex;align-items:center;gap:4px;white-space:nowrap;
    }
    .chip-dot{width:6px;height:6px;border-radius:999px;background:var(--accent)}
    .goal-decks{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
    .badge{
      display:inline-flex;align-items:center;gap:4px;padding:2px 7px;
      border-radius:999px;font-size:10px;text-transform:uppercase;letter-spacing:.12em;
      border:1px solid rgba(148,163,184,.55);color:var(--text-soft);
    }
    .badge-dot{width:6px;height:6px;border-radius:999px;background:rgba(148,163,184,.9)}
    .badge--active{border-color:rgba(56,189,248,.7);color:#e0f2fe}
    .badge--active .badge-dot{background:#38bdf8;box-shadow:0 0 10px rgba(56,189,248,.8)}
    .message-area{margin-top:6px;min-height:16px;font-size:11px}
    .message{
      padding:5px 8px;border-radius:7px;border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.9);color:var(--text-soft);margin-top:4px;
    }
    .message--error{border-color:rgba(248,113,113,.7);color:#fecaca;background:rgba(127,29,29,.6)}
    .message--success{border-color:rgba(34,197,94,.7);color:#bbf7d0;background:rgba(5,46,22,.7)}
    .study-card-wrapper{margin-top:6px}
    .study-card{
      border-radius:14px;border:1px solid rgba(148,163,184,.5);
      background:radial-gradient(circle at top left,rgba(56,189,248,.12),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(34,197,94,.1),transparent 55%),
                 rgba(15,23,42,.98);
      padding:14px 13px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;
      cursor:pointer;transition:transform .22s ease-out,box-shadow .22s ease-out,border-color .22s ease-out,background .2s ease-out;
      box-shadow:0 18px 35px rgba(15,23,42,.9);position:relative;overflow:hidden;
    }
    .study-card:hover{transform:translateY(-1px);box-shadow:0 22px 45px rgba(15,23,42,1);border-color:rgba(56,189,248,.9)}
    .study-card-face-label{
      font-size:10px;text-transform:uppercase;letter-spacing:.16em;
      color:var(--text-soft);margin-bottom:4px;
    }
    .study-card-content{font-size:16px;font-weight:500;color:#f9fafb;white-space:pre-wrap}
    .study-card-topic{font-size:11px;color:var(--text-soft);margin-top:6px}
    .study-card-hint{font-size:11px;color:var(--accent);margin-top:8px}
    .study-footer{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:7px;gap:8px;font-size:11px;color:var(--text-soft);
    }
    .study-actions{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;margin-top:8px;
    }
    .study-actions button{font-size:11px;padding:5px 6px}
    .btn-rating-new{background:rgba(15,23,42,.9);color:var(--text-soft);border:1px solid rgba(148,163,184,.5)}
    .btn-rating-hard{background:rgba(127,29,29,.9);color:#fecaca;border:1px solid rgba(248,113,113,.7)}
    .btn-rating-easy{background:rgba(22,101,52,.98);color:#bbf7d0;border:1px solid rgba(34,197,94,.8)}
    .btn-rating-learned{
      background:linear-gradient(135deg,#22c55e,#4ade80);color:#052e16;
      border:1px solid rgba(190,242,100,.9);box-shadow:0 10px 24px rgba(22,163,74,.9);
    }
    .btn-rating-new:hover{border-color:rgba(148,163,184,.9);color:var(--text)}
    .btn-rating-hard:hover{background:rgba(153,27,27,1)}
    .btn-rating-easy:hover{background:rgba(21,128,61,1)}
    .btn-rating-learned:hover{background:linear-gradient(135deg,#4ade80,#a3e635)}
    .session-bar{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      font-size:11px;margin-top:6px;padding:6px 8px;border-radius:999px;
      background:rgba(15,23,42,.92);border:1px solid rgba(148,163,184,.45);
    }
    .session-bar-left{display:flex;align-items:center;gap:8px}
    .session-dot{
      width:8px;height:8px;border-radius:999px;background:#dc2626;
      box-shadow:0 0 0 0 rgba(248,113,113,.9);
    }
    .session-dot--active{background:#22c55e;animation:pulse 1.4s infinite}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(34,197,94,.9)}
      70%{box-shadow:0 0 0 9px rgba(34,197,94,0)}
      100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
    }
    .panel-split{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px}
    @media(max-width:960px){.panel-split{grid-template-columns:1fr}}
    .chart-container{
      margin-top:6px;border-radius:12px;border:1px solid rgba(15,23,42,.9);
      background:radial-gradient(circle at top left,rgba(30,64,175,.6),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(5,46,22,.7),transparent 55%),#020617;
      padding:10px 9px;position:relative;overflow:hidden;
    }
    .chart-header{
      display:flex;justify-content:space-between;align-items:center;
      font-size:11px;color:var(--text-soft);margin-bottom:4px;gap:8px;
    }
    .chart-legend{display:flex;flex-wrap:wrap;gap:6px}
    .legend-item{
      display:inline-flex;align-items:center;gap:4px;font-size:10px;
      padding:2px 7px;border-radius:999px;border:1px solid rgba(15,23,42,.9);
      background:rgba(15,23,42,.85);
    }
    .legend-swatch{width:10px;height:6px;border-radius:999px;background:var(--accent)}
    .chart-canvas-wrapper{
      border-radius:9px;background:radial-gradient(circle at top,rgba(15,23,42,.9),rgba(15,23,42,.98));
      border:1px solid rgba(15,23,42,.95);padding:6px;overflow:hidden;
    }
    canvas{width:100%;height:160px;display:block}
    .chart-toggle{
      display:inline-flex;align-items:center;gap:4px;padding:2px;
      border-radius:999px;border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);font-size:10px;
    }
    .chart-toggle button{
      border-radius:999px;padding:3px 8px;font-size:10px;
      background:transparent;border:none;color:var(--text-soft);
      box-shadow:none;text-transform:none;letter-spacing:0;
    }
    .chart-toggle button.active{background:rgba(15,23,42,.95);color:#e5e7eb;border-radius:999px}
    .muted{color:var(--text-soft)} .text-right{text-align:right}
    .mt-4{margin-top:4px}.mt-6{margin-top:6px}.mt-8{margin-top:8px}.mt-10{margin-top:10px}
    .flex{display:flex} .flex-between{display:flex;align-items:center;justify-content:space-between}
    .small-label{font-size:10px;color:var(--text-soft)}
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-block">
        <div class="icon-circle">üß†</div>
        <div>
          <h1>Anki Lernstudio<span class="sub">Lokale Progress- &amp; Deck-Verwaltung</span></h1>
          <div class="small-label">Importiere Anki-Decks, definiere Lernziele und verfolge deinen Fortschritt ‚Äì alles lokal im Browser.</div>
        </div>
      </div>
      <div class="meta">
        <div class="pill"><span class="pill-dot"></span><span>Offline &amp; lokal gespeichert</span></div>
        <div>Keine externen Libraries ¬∑ Single HTML</div>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div class="panel-title">Deck-Import &amp; Lernziele<span class="panel-title-pill">JSON-Import ¬∑ Ziele definieren</span></div>
          </div>
          <p class="panel-description">Importiere Anki-Decks im JSON-Format, verkn√ºpfe sie mit Lernzielen und starte Lernsessions mit zuf√§lligen Karten.</p>

          <div class="mt-6">
            <label for="deckFileInput">Anki-Decks importieren (JSON, mehrere Dateien m√∂glich)</label>
            <div class="field-row">
              <input id="deckFileInput" type="file" accept=".json,application/json" multiple />
              <button id="clearAllBtn" class="btn-ghost btn-pill-sm" type="button" title="Alle Daten l√∂schen (Decks, Ziele, Sessions)">Daten zur√ºcksetzen</button>
            </div>
            <div id="importMessageArea" class="message-area"></div>
          </div>

          <div class="mt-8">
            <div class="flex-between">
              <span class="small-label">Importierte Decks</span>
              <span id="deckCountBadge" class="badge"><span class="badge-dot"></span><span id="deckCountText">0 Decks</span></span>
            </div>
            <ul id="deckList" class="deck-list"></ul>
          </div>

          <div class="mt-10 panel-split">
            <div>
              <span class="small-label">Neues Lernziel anlegen</span>
              <div class="mt-4">
                <label for="goalNameInput">Name des Lernziels</label>
                <input id="goalNameInput" type="text" placeholder="z.B. Grundlagen Wiederholung" />
              </div>
              <div class="mt-4">
                <label for="goalDescriptionInput">Kurzbeschreibung (optional)</label>
                <textarea id="goalDescriptionInput" placeholder="Was m√∂chtest du mit diesem Lernziel erreichen?"></textarea>
              </div>
              <div class="mt-4">
                <label for="goalDecksSelect">Zuordnen: Decks f√ºr dieses Lernziel</label>
                <select id="goalDecksSelect" multiple size="4"></select>
                <div class="small-label">Mehrere Decks mit Strg/Cmd-Klick ausw√§hlen.</div>
              </div>
              <div class="mt-6"><button id="addGoalBtn" class="btn-primary" type="button">Lernziel speichern</button></div>
              <div id="goalMessageArea" class="message-area"></div>
            </div>

            <div>
              <div class="flex-between">
                <span class="small-label">Lernziele &amp; Fortschritt</span>
                <span id="goalCountBadge" class="badge"><span class="badge-dot"></span><span id="goalCountText">0 Ziele</span></span>
              </div>
              <ul id="goalList" class="goal-list"></ul>
            </div>
          </div>

          <div class="mt-10">
            <div class="flex-between">
              <span class="small-label">Lernsessions &amp; Karten</span>
              <span id="sessionStatusBadge" class="badge"><span class="badge-dot" id="sessionStatusDot"></span><span id="sessionStatusText">Keine aktive Session</span></span>
            </div>

            <div class="panel-split mt-4">
              <div>
                <div class="mt-2">
                  <label for="sessionDecksSelect">Decks f√ºr Session ausw√§hlen</label>
                  <select id="sessionDecksSelect" multiple size="4"></select>
                  <div class="small-label">Nur ausgew√§hlte Decks werden in dieser Session verwendet.</div>
                </div>
                <div class="mt-4">
                  <label for="sessionGoalSelect">Optional: Lernziel f√ºr Session</label>
                  <select id="sessionGoalSelect"><option value="">Kein Lernziel verkn√ºpfen</option></select>
                </div>
                <div class="mt-6">
                  <button id="startSessionBtn" class="btn-primary" type="button">Session starten</button>
                  <button id="stopSessionBtn" class="btn-ghost" type="button" disabled>Session beenden</button>
                </div>
                <div class="session-bar">
                  <div class="session-bar-left">
                    <div id="sessionDot" class="session-dot"></div>
                    <div>
                      <div id="sessionTimer">00:00</div>
                      <div class="muted" id="sessionDeckSummary">Keine aktive Session</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div id="sessionCardCounter" class="muted">0 Karten ge√ºbt</div>
                    <div id="sessionGoalLabel" class="muted"></div>
                  </div>
                </div>
              </div>

              <div>
                <div class="study-card-wrapper">
                  <div id="studyCard" class="study-card" aria-live="polite">
                    <div>
                      <div id="studyCardFaceLabel" class="study-card-face-label">Vorderseite</div>
                      <div id="studyCardContent" class="study-card-content">Keine Karte verf√ºgbar. Starte eine Session und w√§hle mindestens ein Deck aus.</div>
                      <div id="studyCardTopic" class="study-card-topic"></div>
                    </div>
                    <div id="studyCardHint" class="study-card-hint">Tipp: Klicke auf die Karte oder dr√ºcke die Leertaste, um die R√ºckseite anzuzeigen.</div>
                  </div>
                  <div class="study-footer">
                    <div><span id="studyQueueInfo">0 / 0 Karten in dieser Session</span></div>
                    <div><button id="flipCardBtn" class="btn-ghost btn-pill-sm" type="button">Karte umdrehen</button></div>
                  </div>
                  <div class="study-actions">
                    <button id="rateNewBtn" class="btn-rating-new" type="button" disabled>Neu</button>
                    <button id="rateHardBtn" class="btn-rating-hard" type="button" disabled>Schwer</button>
                    <button id="rateEasyBtn" class="btn-rating-easy" type="button" disabled>Leicht</button>
                    <button id="rateLearnedBtn" class="btn-rating-learned" type="button" disabled>Gelernt</button>
                  </div>
                </div>
                <div id="studyMessageArea" class="message-area"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div class="panel-title">Fortschritt &amp; Visualisierungen<span class="panel-title-pill">Status ¬∑ Zeit ¬∑ Boxplots</span></div>
          </div>
          <p class="panel-description">√úberblick √ºber Kartenanzahl, Themenverteilung, Lernstatus, Zeitaufwand und Aktivit√§t ‚Äì inklusive Boxplot pro Thema.</p>

          <div class="mt-6">
            <div class="stat-pill stat-pill--accent"><span class="stat-pill-dot"></span><span>Gesamt-Karten:</span><span id="summaryTotalCards" class="value">0</span></div>
            <div class="stat-pill"><span>Karten-Themen:</span><span id="summaryTopicCount" class="value">0</span></div>
            <div class="stat-pill stat-pill--success"><span>√ò Fortschritt:</span><span id="summaryOverallProgress" class="value">0%</span></div>
          </div>

          <div class="mt-8 panel-split">
            <div>
              <div class="flex-between">
                <span class="small-label">Karten pro Thema</span>
                <span class="small-label" id="topicSummarySubtitle"></span>
              </div>
              <ul id="topicList" class="deck-list" style="max-height:130px;"></ul>
            </div>
            <div>
              <div class="chart-container">
                <div class="chart-header">
                  <span>Status√ºberblick (neu, gelernt, f√§llig, √ºberf√§llig)</span>
                  <div class="chart-legend">
                    <div class="legend-item"><span class="legend-swatch" style="background:#38bdf8;"></span><span>Neu</span></div>
                    <div class="legend-item"><span class="legend-swatch" style="background:#22c55e;"></span><span>Gelernt</span></div>
                    <div class="legend-item"><span class="legend-swatch" style="background:#facc15;"></span><span>F√§llig</span></div>
                    <div class="legend-item"><span class="legend-swatch" style="background:#f97316;"></span><span>√úberf√§llig</span></div>
                  </div>
                </div>
                <div class="chart-canvas-wrapper"><canvas id="statusChart"></canvas></div>
              </div>
            </div>
          </div>

          <div class="mt-10">
            <div class="chart-container">
              <div class="chart-header">
                <span>Zeitaufwand &amp; Kartenaktivit√§t (t√§glich / w√∂chentlich)</span>
                <div class="chart-toggle">
                  <button id="activityDailyBtn" type="button" class="active">T√§glich</button>
                  <button id="activityWeeklyBtn" type="button">W√∂chentlich</button>
                </div>
              </div>
              <div class="chart-canvas-wrapper"><canvas id="activityChart"></canvas></div>
            </div>
          </div>

          <div class="mt-10">
            <div class="chart-container">
              <div class="chart-header">
                <span>Boxplot nach Themen (Wdh.-Abst√§nde)</span>
                <div class="chart-legend" id="boxplotLegend"></div>
              </div>
              <div class="chart-canvas-wrapper"><canvas id="boxplotChart"></canvas></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function(){
      "use strict";
      const STORAGE_KEY="ankiLernstudioAppState_v1";
      function safeParse(json){try{return JSON.parse(json)}catch(e){return null}}
      function formatDateISO(d){return d.toISOString().slice(0,10)}
      function parseISOToDate(s){if(!s)return null;const d=new Date(s);return isNaN(d.getTime())?null:d}
      function dateAddDays(b,days){const d=new Date(b.getTime());d.setDate(d.getDate()+days);return d}
      function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
      function hashColor(str){let h=0;for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i);h|=0}const hh=Math.abs(h)%360;return "hsl("+hh+",70%,60%)"}
      const DataModel=(function(){
        let state={decks:[],goals:[],sessions:[]};
        function load(){
          const raw=localStorage.getItem(STORAGE_KEY);
          if(!raw){state={decks:[],goals:[],sessions:[]};return}
          const p=safeParse(raw);
          if(!p||typeof p!=="object"){state={decks:[],goals:[],sessions:[]};return}
          state.decks=Array.isArray(p.decks)?p.decks:[];state.goals=Array.isArray(p.goals)?p.goals:[];state.sessions=Array.isArray(p.sessions)?p.sessions:[];
        }
        function save(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}catch(e){}}
        function clearAll(){state={decks:[],goals:[],sessions:[]};save()}
        function getState(){return state}
        function importDeck(deckObj){
          if(!deckObj||typeof deckObj!=="object"||typeof deckObj.deckName!=="string"||!Array.isArray(deckObj.cards)){
            throw new Error("Ung√ºltiges Deck-Format. Erwartet: { deckName: string, cards: [] }");
          }
          const name=String(deckObj.deckName).trim();
          if(!name) throw new Error("Deck ohne Namen kann nicht importiert werden.");
          if(!deckObj.cards.length) throw new Error('Deck "'+name+'" enth√§lt keine Karten.');
          const deckId="deck-"+Date.now()+"-"+Math.random().toString(16).slice(2,8);
          const seenOriginalIds=new Set();
          const cards=deckObj.cards.map(function(c,idx){
            const cardIndex=idx+1;
            if(!c||typeof c.front!=="string"||typeof c.back!=="string"||typeof c.topic!=="string"){
              throw new Error('Deck "'+name+'": Karte '+cardIndex+" besitzt ung√ºltige Felder.");
            }
            const front=String(c.front).trim();
            const back=String(c.back).trim();
            const topic=String(c.topic).trim();
            if(!front||!back||!topic){
              throw new Error('Deck "'+name+'": Karte '+cardIndex+" hat leere Vorder-, R√ºckseite oder Thema.");
            }
            const rawId=(typeof c.id==="string"&&c.id.trim())?c.id.trim():String(cardIndex);
            if(seenOriginalIds.has(rawId)){
              throw new Error('Deck "'+name+'": doppelte Karten-ID "'+rawId+'" (z.B. Karte '+cardIndex+").");
            }
            seenOriginalIds.add(rawId);
            let safeLast=null;
            if(c.lastReviewed!=null){
              const parsedLast=parseISOToDate(c.lastReviewed);
              if(!parsedLast){
                throw new Error('Deck "'+name+'": Karte '+cardIndex+' hat ein ung√ºltiges Datum in "lastReviewed".');
              }
              safeLast=formatDateISO(parsedLast);
            }
            let difficulty="new";
            if(typeof c.status==="string"&&c.status.trim()){
              const s=c.status.toLowerCase().trim();
              const allowed=["new","hard","easy","learned"];
              if(allowed.indexOf(s)===-1){
                throw new Error('Deck "'+name+'": Karte '+cardIndex+' hat einen unbekannten Status "'+c.status+'". Erlaubt: new, hard, easy, learned.');
              }
              difficulty=s;
            }
            const now=new Date();
            let nextDue=null;
            if(safeLast){
              const base=difficulty==="learned"?7:difficulty==="easy"?3:difficulty==="hard"?2:1;
              nextDue=formatDateISO(dateAddDays(parseISOToDate(safeLast),base));
            }
            return{
              id:deckId+"::"+rawId,
              originalId:rawId,
              front,
              back,
              topic,
              difficulty,
              lastReviewed:safeLast,
              nextDue,
              createdAt:formatDateISO(now),
              history:[]
            };
          });
          const deck={id:deckId,name:name,cards,importedAt:new Date().toISOString()};
          state.decks.push(deck);save();return deck;
        }
        function addGoal(name,desc,deckIds){
          const trimmed=(name||"").trim();
          if(!trimmed)throw new Error("Bitte einen Namen f√ºr das Lernziel angeben.");
          const id="goal-"+Date.now()+"-"+Math.random().toString(16).slice(2,7);
          const goal={id,name:trimmed,description:(desc||"").trim(),deckIds:Array.isArray(deckIds)?deckIds.slice():[],createdAt:new Date().toISOString()};
          state.goals.push(goal);save();return goal;
        }
        function addSession(s){state.sessions.push(s);save()}
        function updateCard(deckId,cardId,fn){
          const d=state.decks.find(x=>x.id===deckId);if(!d)return;
          const c=d.cards.find(x=>x.id===cardId);if(!c)return;fn(c);save();
        }
        return{load,save,clearAll,getState,importDeck,addGoal,addSession,updateCard};
      })();
      const Logic=(function(){
        function computeCardStatus(card,todayStr){
          const today=todayStr||formatDateISO(new Date());
          if(!card.lastReviewed)return"new";
          const next=card.nextDue||card.lastReviewed;
          if(next>today)return"learned";
          if(next===today)return"due";
          if(next<today)return"overdue";
          return"new";
        }
        function collectAllCards(state){
          const res=[];state.decks.forEach(d=>d.cards.forEach(c=>res.push({deckId:d.id,deckName:d.name,card:c})));
          return res;
        }
        function computeOverview(state){
          const all=collectAllCards(state);const totalCards=all.length;
          const topicMap={};const statusCounts={new:0,learned:0,due:0,overdue:0};
          const today=formatDateISO(new Date());
          all.forEach(entry=>{
            const topic=entry.card.topic||"ohne Thema";
            if(!topicMap[topic])topicMap[topic]={topic,total:0,learned:0};
            topicMap[topic].total++;
            const s=computeCardStatus(entry.card,today);
            if(statusCounts.hasOwnProperty(s))statusCounts[s]++;
            if(s==="learned")topicMap[topic].learned++;
          });
          const topics=Object.keys(topicMap).sort().map(t=>{
            const o=topicMap[t];const prog=o.total?o.learned/o.total:0;
            return{topic:t,total:o.total,learned:o.learned,progress:prog};
          });
          let overall=0;if(topics.length>0)overall=topics.reduce((s,t)=>s+t.progress,0)/topics.length;
          return{totalCards,topics,statusCounts,overallProgress:overall};
        }
        function buildStudyQueue(state,deckIds){
          const decks=state.decks.filter(d=>deckIds.indexOf(d.id)!==-1);
          const today=formatDateISO(new Date());const q=[];
          decks.forEach(deck=>{
            deck.cards.forEach((card,idx)=>{
              const s=computeCardStatus(card,today);
              if(s==="new"||s==="due"||s==="overdue"||s==="learned"){
                q.push({deckId:deck.id,deckName:deck.name,cardId:card.id,cardIndex:idx});
              }
            });
          });
          return shuffleArray(q);
        }
        function recordReview(deckId,cardId,rating,sessionId){
          const now=new Date();const today=formatDateISO(now);
          DataModel.updateCard(deckId,cardId,card=>{
            const hist=Array.isArray(card.history)?card.history:[];
            hist.push({timestamp:now.toISOString(),rating,sessionId:sessionId||null});
            card.history=hist;card.lastReviewed=today;card.difficulty=rating;
            let base; if(rating==="learned")base=7;else if(rating==="easy")base=3;else if(rating==="hard")base=2;else base=1;
            const factor=Math.max(1,hist.length);const interval=base*factor;
            card.nextDue=formatDateISO(dateAddDays(now,interval));
          });
        }
        function computeActivity(state,mode){
          const g={};
          state.sessions.forEach(s=>{
            const start=parseISOToDate(s.startTime);if(!start)return;
            let key;
            if(mode==="weekly"){
              const year=start.getFullYear();const firstJan=new Date(year,0,1);
              const pastDays=Math.floor((start-firstJan)/(24*60*60*1000));
              const week=Math.floor((pastDays+firstJan.getDay())/7)+1;
              key=year+"-KW"+week;
            }else key=formatDateISO(start);
            if(!g[key])g[key]={durationMs:0,cardsReviewed:0};
            g[key].durationMs+=s.durationMs||0;g[key].cardsReviewed+=s.cardsReviewed||0;
          });
          return Object.keys(g).sort().map(k=>({label:k,minutes:(g[k].durationMs||0)/60000,cards:g[k].cardsReviewed||0}));
        }
        function computeBoxplot(state){
          const perTopic={};
          state.decks.forEach(deck=>{
            deck.cards.forEach(card=>{
              const topic=card.topic||"ohne Thema";if(!perTopic[topic])perTopic[topic]=[];
              const hist=Array.isArray(card.history)?card.history.slice():[];
              hist.sort((a,b)=>a.timestamp.localeCompare(b.timestamp));
              for(let i=1;i<hist.length;i++){
                const p=parseISOToDate(hist[i-1].timestamp);const c=parseISOToDate(hist[i].timestamp);
                if(!p||!c)continue;perTopic[topic].push((c-p)/(24*60*60*1000));
              }
            });
          });
          const topics=Object.keys(perTopic).sort();
          return topics.map(t=>{
            const arr=perTopic[t].slice().sort((a,b)=>a-b);
            if(!arr.length)return{topic:t,min:0,q1:0,median:0,q3:0,max:0};
            function quantile(sorted,q){
              const pos=(sorted.length-1)*q;const base=Math.floor(pos);const rest=pos-base;
              if(sorted[base+1]!==undefined)return sorted[base]+rest*(sorted[base+1]-sorted[base]);
              return sorted[base];
            }
            return{topic:t,min:arr[0],q1:quantile(arr,.25),median:quantile(arr,.5),q3:quantile(arr,.75),max:arr[arr.length-1]};
          });
        }
        return{computeCardStatus,computeOverview,buildStudyQueue,recordReview,computeActivity,computeBoxplot};
      })();
      const UI=(function(){
        let el={},currentSession=null,sessionTimerInterval=null,currentCardIndex=-1,isBackShown=false,currentQueue=[],activityMode="daily";
        function cache(){
          el.deckFileInput=document.getElementById("deckFileInput");
          el.importMessageArea=document.getElementById("importMessageArea");
          el.deckList=document.getElementById("deckList");
          el.deckCountText=document.getElementById("deckCountText");
          el.goalNameInput=document.getElementById("goalNameInput");
          el.goalDescriptionInput=document.getElementById("goalDescriptionInput");
          el.goalDecksSelect=document.getElementById("goalDecksSelect");
          el.addGoalBtn=document.getElementById("addGoalBtn");
          el.goalList=document.getElementById("goalList");
          el.goalCountText=document.getElementById("goalCountText");
          el.goalMessageArea=document.getElementById("goalMessageArea");
          el.sessionDecksSelect=document.getElementById("sessionDecksSelect");
          el.sessionGoalSelect=document.getElementById("sessionGoalSelect");
          el.startSessionBtn=document.getElementById("startSessionBtn");
          el.stopSessionBtn=document.getElementById("stopSessionBtn");
          el.sessionDot=document.getElementById("sessionDot");
          el.sessionTimer=document.getElementById("sessionTimer");
          el.sessionDeckSummary=document.getElementById("sessionDeckSummary");
          el.sessionCardCounter=document.getElementById("sessionCardCounter");
          el.sessionGoalLabel=document.getElementById("sessionGoalLabel");
          el.sessionStatusBadge=document.getElementById("sessionStatusBadge");
          el.sessionStatusText=document.getElementById("sessionStatusText");
          el.studyCard=document.getElementById("studyCard");
          el.studyCardFaceLabel=document.getElementById("studyCardFaceLabel");
          el.studyCardContent=document.getElementById("studyCardContent");
          el.studyCardTopic=document.getElementById("studyCardTopic");
          el.studyCardHint=document.getElementById("studyCardHint");
          el.flipCardBtn=document.getElementById("flipCardBtn");
          el.studyQueueInfo=document.getElementById("studyQueueInfo");
          el.studyMessageArea=document.getElementById("studyMessageArea");
          el.rateNewBtn=document.getElementById("rateNewBtn");
          el.rateHardBtn=document.getElementById("rateHardBtn");
          el.rateEasyBtn=document.getElementById("rateEasyBtn");
          el.rateLearnedBtn=document.getElementById("rateLearnedBtn");
          el.summaryTotalCards=document.getElementById("summaryTotalCards");
          el.summaryTopicCount=document.getElementById("summaryTopicCount");
          el.summaryOverallProgress=document.getElementById("summaryOverallProgress");
          el.topicList=document.getElementById("topicList");
          el.topicSummarySubtitle=document.getElementById("topicSummarySubtitle");
          el.statusChart=document.getElementById("statusChart");
          el.activityChart=document.getElementById("activityChart");
          el.activityDailyBtn=document.getElementById("activityDailyBtn");
          el.activityWeeklyBtn=document.getElementById("activityWeeklyBtn");
          el.boxplotChart=document.getElementById("boxplotChart");
          el.boxplotLegend=document.getElementById("boxplotLegend");
          el.clearAllBtn=document.getElementById("clearAllBtn");
        }
        function msg(area,text,type){
          area.innerHTML="";if(!text)return;
          const d=document.createElement("div");
          d.className="message"+(type==="error"?" message--error":type==="success"?" message--success":"");
          d.textContent=text;area.appendChild(d);
        }
        function renderDecks(){
          const state=DataModel.getState(),decks=state.decks;
          el.deckList.innerHTML="";
          if(!decks.length){
            const li=document.createElement("li");
            li.className="deck-list-item";
            li.innerHTML='<div class="deck-name muted">Noch keine Decks importiert.</div><div class="deck-meta text-right">Nutze den JSON-Import oben.</div>';
            el.deckList.appendChild(li);
          }else{
            decks.slice().reverse().forEach(deck=>{
              const li=document.createElement("li");li.className="deck-list-item";
              const left=document.createElement("div"),right=document.createElement("div");
              const nameEl=document.createElement("div");nameEl.className="deck-name";nameEl.textContent=deck.name;left.appendChild(nameEl);
              const topicTags=document.createElement("div");topicTags.className="deck-topic-tags";
              const topics={};deck.cards.forEach(c=>{const t=c.topic||"ohne Thema";topics[t]=(topics[t]||0)+1});
              Object.keys(topics).slice(0,5).forEach(t=>{
                const chip=document.createElement("span");chip.className="chip";
                const dot=document.createElement("span");dot.className="chip-dot";chip.appendChild(dot);
                chip.appendChild(document.createTextNode(" "+t+" ("+topics[t]+")"));topicTags.appendChild(chip);
              });
              left.appendChild(topicTags);
              const meta=document.createElement("div");meta.className="deck-meta text-right";
              const imp=deck.importedAt?deck.importedAt.slice(0,10):"";meta.textContent=deck.cards.length+" Karten ¬∑ importiert am "+imp;
              right.appendChild(meta);li.appendChild(left);li.appendChild(right);el.deckList.appendChild(li);
            });
          }
          const count=decks.length;el.deckCountText.textContent=count+(count===1?" Deck":" Decks");
        }
        function renderSelects(){
          const state=DataModel.getState(),decks=state.decks;
          el.goalDecksSelect.innerHTML="";decks.forEach(deck=>{
            const o=document.createElement("option");o.value=deck.id;o.textContent=deck.name+" ("+deck.cards.length+" Karten)";
            el.goalDecksSelect.appendChild(o);
          });
          el.sessionDecksSelect.innerHTML="";decks.forEach(deck=>{
            const o=document.createElement("option");o.value=deck.id;o.textContent=deck.name+" ("+deck.cards.length+" Karten)";
            el.sessionDecksSelect.appendChild(o);
          });
          const currentVal=el.sessionGoalSelect.value;el.sessionGoalSelect.innerHTML="";
          const base=document.createElement("option");base.value="";base.textContent="Kein Lernziel verkn√ºpfen";el.sessionGoalSelect.appendChild(base);
          state.goals.forEach(goal=>{
            const o=document.createElement("option");o.value=goal.id;o.textContent=goal.name;el.sessionGoalSelect.appendChild(o);
          });
          const exists=state.goals.some(g=>g.id===currentVal);if(exists)el.sessionGoalSelect.value=currentVal;
        }
        function renderGoals(){
          const state=DataModel.getState(),goals=state.goals;
          el.goalList.innerHTML="";
          if(!goals.length){
            const li=document.createElement("li");li.className="goal-list-item";
            li.innerHTML='<div class="deck-name muted">Noch keine Lernziele angelegt.</div><div class="goal-meta text-right">Definiere Ziele, um mehrere Decks zu b√ºndeln.</div>';
            el.goalList.appendChild(li);
          }else{
            const overview=Logic.computeOverview(state);
            goals.slice().reverse().forEach(goal=>{
              const li=document.createElement("li");li.className="goal-list-item";
              const left=document.createElement("div"),right=document.createElement("div");
              const title=document.createElement("div");title.className="deck-name";title.textContent=goal.name;left.appendChild(title);
              if(goal.description){
                const desc=document.createElement("div");desc.className="goal-meta";desc.textContent=goal.description;left.appendChild(desc);
              }
              const deckCount=goal.deckIds.length;
              const meta=document.createElement("div");meta.className="goal-meta text-right";
              meta.textContent=deckCount+(deckCount===1?" Deck":" Decks")+" zugeordnet";right.appendChild(meta);
              const cont=document.createElement("div");cont.className="goal-decks";const set=new Set(goal.deckIds);
              overview.topics.forEach(topic=>{
                const list=[];
                DataModel.getState().decks.forEach(deck=>{
                  if(!set.has(deck.id))return;
                  deck.cards.forEach(card=>{if(card.topic===topic.topic)list.push(card)});
                });
                if(!list.length)return;
                const learned=list.filter(card=>Logic.computeCardStatus(card)==="learned").length;
                const prog=list.length?learned/list.length:0;
                const chip=document.createElement("span");chip.className="chip";
                const dot=document.createElement("span");dot.className="chip-dot";chip.appendChild(dot);
                chip.appendChild(document.createTextNode(" "+topic.topic+" ¬∑ "+Math.round(prog*100)+"% ("+learned+"/"+list.length+")"));
                cont.appendChild(chip);
              });
              left.appendChild(cont);li.appendChild(left);li.appendChild(right);el.goalList.appendChild(li);
            });
          }
          const cnt=goals.length;el.goalCountText.textContent=cnt+(cnt===1?" Lernziel":" Lernziele");
        }
        function resizeCanvas(c){const r=c.getBoundingClientRect(),dpr=window.devicePixelRatio||1;
          const w=r.width*dpr,h=r.height*dpr;if(c.width!==w||c.height!==h){c.width=w;c.height=h}
          return{width:w,height:h,dpr};
        }
        function drawStatusChart(status){
          const c=el.statusChart;if(!c)return;const ctx=c.getContext("2d"),d=resizeCanvas(c),w=d.width,h=d.height;
          ctx.clearRect(0,0,w,h);
          const labels=["Neu","Gelernt","F√§llig","√úberf√§llig"],keys=["new","learned","due","overdue"],colors=["#38bdf8","#22c55e","#facc15","#f97316"];
          const vals=keys.map(k=>status[k]||0),maxVal=Math.max(1,Math.max.apply(null,vals));
          const pad={left:40,right:12,top:16,bottom:28},cw=w-pad.left-pad.right,ch=h-pad.top-pad.bottom,barW=cw/(vals.length*1.7);
          ctx.font="11px system-ui";ctx.fillStyle="rgba(148,163,184,.7)";ctx.textAlign="right";ctx.textBaseline="middle";
          const grid=4;for(let i=0;i<=grid;i++){
            const y=pad.top+ch*i/grid,val=Math.round(maxVal-maxVal*i/grid);
            ctx.strokeStyle="rgba(15,23,42,.9)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();
            ctx.fillText(val,pad.left-6,y);
          }
          ctx.textAlign="center";ctx.textBaseline="top";
          vals.forEach((v,i)=>{
            const xCenter=pad.left+(cw/(vals.length+1))*(i+1);
            const barH=(v/maxVal)*ch,x=xCenter-barW/2,y=pad.top+(ch-barH);
            const g=ctx.createLinearGradient(x,y,x,y+barH);g.addColorStop(0,colors[i]);g.addColorStop(1,"rgba(15,23,42,.9)");
            ctx.fillStyle=g;ctx.beginPath();const r=6;
            ctx.moveTo(x,y+barH);ctx.lineTo(x,y+r);
            ctx.quadraticCurveTo(x,y,x+r,y);ctx.lineTo(x+barW-r,y);
            ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);ctx.lineTo(x+barW,y+barH);ctx.closePath();ctx.fill();
            ctx.fillStyle="rgba(148,163,184,.8)";ctx.fillText(labels[i],xCenter,h-pad.bottom+4);
            if(v>0){ctx.fillStyle="#f9fafb";ctx.textBaseline="bottom";ctx.fillText(v,xCenter,y-2);ctx.textBaseline="top";}
          });
        }
        function drawActivityChart(){
          const c=el.activityChart;if(!c)return;const ctx=c.getContext("2d"),d=resizeCanvas(c),w=d.width,h=d.height;
          ctx.clearRect(0,0,w,h);
          const state=DataModel.getState(),data=Logic.computeActivity(state,activityMode==="weekly"?"weekly":"daily");
          if(!data.length){
            ctx.fillStyle="rgba(148,163,184,.7)";ctx.font="12px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
            ctx.fillText("Noch keine Sessions ‚Äì starte eine Lernsitzung, um Aktivit√§t zu sehen.",w/2,h/2);return;
          }
          const maxCards=Math.max.apply(null,data.map(d=>d.cards));
          const maxMinutes=Math.max.apply(null,data.map(d=>d.minutes));
          const maxVal=Math.max(1,maxCards,maxMinutes);
          const pad={left:40,right:12,top:18,bottom:40},cw=w-pad.left-pad.right,ch=h-pad.top-pad.bottom;
          ctx.font="11px system-ui";ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillStyle="rgba(148,163,184,.7)";
          const grid=4;for(let i=0;i<=grid;i++){
            const y=pad.top+ch*i/grid,val=Math.round(maxVal-maxVal*i/grid);
            ctx.strokeStyle="rgba(15,23,42,.9)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();
            ctx.fillText(val,pad.left-6,y);
          }
          const barW=cw/(data.length*2.2);
          data.forEach((dItem,i)=>{
            const xCenter=pad.left+(cw/(data.length+1))*(i+1);
            const cardsH=(dItem.cards/maxVal)*ch,minutesH=(dItem.minutes/maxVal)*ch;
            const xC=xCenter-barW-1,yC=pad.top+(ch-cardsH);ctx.fillStyle="#38bdf8";ctx.fillRect(xC,yC,barW,cardsH);
            const xM=xCenter+1,yM=pad.top+(ch-minutesH);
            const g=ctx.createLinearGradient(xM,yM,xM,yM+minutesH);g.addColorStop(0,"#22c55e");g.addColorStop(1,"rgba(15,23,42,.95)");
            ctx.fillStyle=g;ctx.fillRect(xM,yM,barW,minutesH);
            ctx.save();ctx.translate(xCenter,h-pad.bottom+8);ctx.rotate(-Math.PI/9);
            ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillStyle="rgba(148,163,184,.8)";ctx.fillText(dItem.label,0,0);ctx.restore();
          });
          ctx.font="10px system-ui";ctx.fillStyle="rgba(148,163,184,.85)";
          ctx.textAlign="left";ctx.textBaseline="top";ctx.fillText("Karten",pad.left+2,pad.top+2);
          ctx.fillStyle="rgba(34,197,94,.85)";ctx.fillText("Minuten",pad.left+42,pad.top+2);
        }
        function drawBoxplotChart(){
          const c=el.boxplotChart;if(!c)return;const ctx=c.getContext("2d"),d=resizeCanvas(c),w=d.width,h=d.height;
          ctx.clearRect(0,0,w,h);el.boxplotLegend.innerHTML="";
          const state=DataModel.getState(),data=Logic.computeBoxplot(state);
          if(!data.length){
            ctx.fillStyle="rgba(148,163,184,.7)";ctx.font="12px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
            ctx.fillText("Noch keine Wiederholungsdaten ‚Äì √ºbe Karten mehrmals, um Boxplots zu sehen.",w/2,h/2);return;
          }
          const vals=[];data.forEach(dItem=>{vals.push(dItem.min,dItem.q1,dItem.median,dItem.q3,dItem.max)});
          const globalMin=Math.min.apply(null,vals),globalMax=Math.max.apply(null,vals),range=globalMax-globalMin||1;
          const pad={left:40,right:18,top:18,bottom:40},cw=w-pad.left-pad.right,ch=h-pad.top-pad.bottom;
          ctx.font="11px system-ui";ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillStyle="rgba(148,163,184,.7)";
          const grid=4;for(let i=0;i<=grid;i++){
            const y=pad.top+ch*i/grid,val=globalMax-range*i/grid;
            ctx.strokeStyle="rgba(15,23,42,.95)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();
            ctx.fillText(val.toFixed(1),pad.left-6,y);
          }
          const boxW=cw/(data.length*1.6);
          data.forEach((dItem,i)=>{
            const xCenter=pad.left+(cw/(data.length+1))*(i+1);
            function yVal(val){return pad.top+ch*(1-(val-globalMin)/range)}
            const yMin=yVal(dItem.min),yQ1=yVal(dItem.q1),yM=yVal(dItem.median),yQ3=yVal(dItem.q3),yMax=yVal(dItem.max);
            const color=hashColor(dItem.topic);ctx.strokeStyle=color;ctx.lineWidth=2;
            ctx.beginPath();ctx.moveTo(xCenter,yMin);ctx.lineTo(xCenter,yMax);ctx.stroke();
            const half=boxW/2;
            ctx.fillStyle="rgba(15,23,42,.95)";ctx.fillRect(xCenter-half,yQ3,boxW,yQ1-yQ3);
            ctx.strokeStyle=color;ctx.strokeRect(xCenter-half,yQ3,boxW,yQ1-yQ3);
            ctx.beginPath();ctx.moveTo(xCenter-half,yM);ctx.lineTo(xCenter+half,yM);ctx.stroke();
            ctx.beginPath();ctx.moveTo(xCenter-half/1.4,yMin);ctx.lineTo(xCenter+half/1.4,yMin);
            ctx.moveTo(xCenter-half/1.4,yMax);ctx.lineTo(xCenter+half/1.4,yMax);ctx.stroke();
            ctx.save();ctx.translate(xCenter,h-pad.bottom+10);ctx.rotate(-Math.PI/9);
            ctx.textAlign="right";ctx.textBaseline="middle";ctx.fillStyle="rgba(148,163,184,.85)";
            const label=dItem.topic.length>16?dItem.topic.slice(0,13)+"‚Ä¶":dItem.topic;
            ctx.fillText(label,0,0);ctx.restore();
            const li=document.createElement("div");li.className="legend-item";
            const sw=document.createElement("span");sw.className="legend-swatch";sw.style.background=color;
            li.appendChild(sw);
            li.appendChild(document.createTextNode(" "+(dItem.topic.length>16?dItem.topic.slice(0,13)+"‚Ä¶":dItem.topic)));
            el.boxplotLegend.appendChild(li);
          });
          ctx.font="10px system-ui";ctx.fillStyle="rgba(148,163,184,.85)";
          ctx.textAlign="left";ctx.textBaseline="top";ctx.fillText("Tage zwischen Wiederholungen",pad.left+2,pad.top+2);
        }
        function updateSessionUI(){
          if(!currentSession){
            el.sessionDot.classList.remove("session-dot--active");
            el.sessionDeckSummary.textContent="Keine aktive Session";
            el.sessionCardCounter.textContent="0 Karten ge√ºbt";
            el.sessionGoalLabel.textContent="";
            el.startSessionBtn.disabled=false;el.stopSessionBtn.disabled=true;
            el.sessionStatusBadge.classList.remove("badge--active");
            el.sessionStatusText.textContent="Keine aktive Session";
            el.studyCardHint.textContent="Starte eine Session und w√§hle mindestens ein Deck aus.";
            el.rateNewBtn.disabled=el.rateHardBtn.disabled=el.rateEasyBtn.disabled=el.rateLearnedBtn.disabled=true;
            el.flipCardBtn.disabled=true;
            if(sessionTimerInterval){clearInterval(sessionTimerInterval);sessionTimerInterval=null}
            el.sessionTimer.textContent="00:00";return;
          }
          el.sessionDot.classList.add("session-dot--active");
          el.sessionDeckSummary.textContent=currentSession.deckIds.length+(currentSession.deckIds.length===1?" Deck ausgew√§hlt":" Decks ausgew√§hlt");
          el.sessionCardCounter.textContent=currentSession.cardsReviewed+" Karten ge√ºbt";
          if(currentSession.goalId){
            const st=DataModel.getState(),goal=st.goals.find(g=>g.id===currentSession.goalId);
            el.sessionGoalLabel.textContent=goal?"Ziel: "+goal.name:"Ziel: (nicht gefunden)";
          }else el.sessionGoalLabel.textContent="Kein Lernziel verkn√ºpft";
          el.startSessionBtn.disabled=true;el.stopSessionBtn.disabled=false;
          el.sessionStatusBadge.classList.add("badge--active");el.sessionStatusText.textContent="Session l√§uft";
          el.rateNewBtn.disabled=el.rateHardBtn.disabled=el.rateEasyBtn.disabled=el.rateLearnedBtn.disabled=false;
          el.flipCardBtn.disabled=false;
          if(!sessionTimerInterval){
            sessionTimerInterval=setInterval(function(){
              if(!currentSession){clearInterval(sessionTimerInterval);sessionTimerInterval=null;return}
              const diff=Date.now()-currentSession.startTimeMs,total=Math.floor(diff/1000);
              const mins=String(Math.floor(total/60)).padStart(2,"0"),secs=String(total%60).padStart(2,"0");
              el.sessionTimer.textContent=mins+":"+secs;
            },1000);
          }
        }
        function updateStudyCard(){
          const total=currentQueue.length,shown=currentCardIndex+1;
          el.studyQueueInfo.textContent=(shown<0?0:shown)+" / "+total+" Karten in dieser Session";
          if(!currentSession||!currentQueue.length){
            el.studyCardFaceLabel.textContent="Vorderseite";
            el.studyCardContent.textContent="Keine Karte verf√ºgbar. Starte eine Session und w√§hle mindestens ein Deck aus.";
            el.studyCardTopic.textContent="";
            el.studyCardHint.textContent="Tipp: Importiere Decks und starte anschlie√üend eine Lernsitzung.";
            el.rateNewBtn.disabled=el.rateHardBtn.disabled=el.rateEasyBtn.disabled=el.rateLearnedBtn.disabled=true;
            el.flipCardBtn.disabled=true;return;
          }
          el.rateNewBtn.disabled=el.rateHardBtn.disabled=el.rateEasyBtn.disabled=el.rateLearnedBtn.disabled=false;
          el.flipCardBtn.disabled=false;
          if(currentCardIndex<0||currentCardIndex>=currentQueue.length){
            el.studyCardFaceLabel.textContent="Session abgeschlossen";
            el.studyCardContent.textContent="Alle Karten dieser Session wurden bearbeitet. Du kannst die Session beenden oder neu starten.";
            el.studyCardTopic.textContent="";
            el.studyCardHint.textContent="Beende die Session oder starte eine neue mit anderen Decks.";return;
          }
          const state=DataModel.getState(),ref=currentQueue[currentCardIndex];
          const deck=state.decks.find(d=>d.id===ref.deckId);
          const card=deck&&deck.cards.find(c=>c.id===ref.cardId);
          if(!deck||!card){el.studyCardContent.textContent="Fehler beim Laden der Karte.";el.studyCardTopic.textContent="";return;}
          if(!isBackShown){el.studyCardFaceLabel.textContent="Vorderseite";el.studyCardContent.textContent=card.front;}
          else{el.studyCardFaceLabel.textContent="R√ºckseite";el.studyCardContent.textContent=card.back;}
          el.studyCardTopic.textContent="Thema: "+(card.topic||"ohne Thema")+" ¬∑ Deck: "+deck.name;
          el.studyCardHint.textContent=isBackShown?"Bewerte jetzt die Karte: Neu, Schwer, Leicht oder Gelernt.":"Klicke auf die Karte oder dr√ºcke die Leertaste, um die R√ºckseite anzuzeigen.";
        }
        function nextCard(){
          if(!currentQueue.length){updateStudyCard();return;}
          if(currentCardIndex<currentQueue.length-1)currentCardIndex++;else currentCardIndex=currentQueue.length;
          isBackShown=false;updateStudyCard();
        }
        function flip(){if(!currentSession||!currentQueue.length)return;if(currentCardIndex<0||currentCardIndex>=currentQueue.length)return;isBackShown=!isBackShown;updateStudyCard();}
        function rate(r){
          if(!currentSession||!currentQueue.length)return;
          if(currentCardIndex<0||currentCardIndex>=currentQueue.length)return;
          const ref=currentQueue[currentCardIndex];
          Logic.recordReview(ref.deckId,ref.cardId,r,currentSession.id);
          currentSession.cardsReviewed++;updateSessionUI();renderOverview();nextCard();
        }
        function startSession(){
          const opts=Array.from(el.sessionDecksSelect.options);
          const deckIds=opts.filter(o=>o.selected).map(o=>o.value);
          if(!deckIds.length){msg(el.studyMessageArea,"Bitte mindestens ein Deck f√ºr die Session ausw√§hlen.","error");return;}
          const state=DataModel.getState(),queue=Logic.buildStudyQueue(state,deckIds);
          if(!queue.length){msg(el.studyMessageArea,"Keine Karten in den ausgew√§hlten Decks gefunden.","error");return;}
          const goalId=el.sessionGoalSelect.value||null;
          currentSession={id:"session-"+Date.now()+"-"+Math.random().toString(16).slice(2,7),
            deckIds:deckIds.slice(),goalId,startTimeMs:Date.now(),startTime:new Date().toISOString(),
            durationMs:0,cardsReviewed:0,reviews:[]};
          currentQueue=queue;currentCardIndex=-1;isBackShown=false;
          msg(el.studyMessageArea,"","");nextCard();updateSessionUI();
        }
        function stopSession(){
          if(!currentSession)return;
          currentSession.durationMs=Date.now()-currentSession.startTimeMs;
          currentSession.endTime=new Date().toISOString();
          DataModel.addSession({id:currentSession.id,deckIds:currentSession.deckIds.slice(),goalId:currentSession.goalId,
            startTime:currentSession.startTime,endTime:currentSession.endTime,durationMs:currentSession.durationMs,cardsReviewed:currentSession.cardsReviewed});
          currentSession=null;currentQueue=[];currentCardIndex=-1;isBackShown=false;
          updateSessionUI();updateStudyCard();renderOverview();
          msg(el.studyMessageArea,"Session gespeichert. Danke f√ºr deinen Lern-Einsatz!","success");
        }
        function importFiles(files){
          if(!files||!files.length)return;
          let success=0,errors=[],pending=files.length;
          Array.from(files).forEach(file=>{
            const reader=new FileReader();
            reader.onload=function(ev){
              try{
                const text=ev.target.result,json=safeParse(text);
                if(!json)throw new Error("Ung√ºltiges JSON.");
                DataModel.importDeck(json);success++;
              }catch(e){
                errors.push('Datei "'+file.name+'": '+(e&&e.message?e.message:"Unbekannter Fehler beim Import."));
              }finally{
                pending--;if(pending===0){
                  if(success>0)msg(el.importMessageArea,success+" Deck(s) erfolgreich importiert."+(errors.length?" Einige Dateien konnten nicht geladen werden.":""),"success");
                  if(errors.length)msg(el.importMessageArea,errors.join(" "),"error");
                  renderDecks();renderSelects();renderGoals();renderOverview();
                }
              }
            };
            reader.onerror=function(){
              pending--;errors.push('Fehler beim Lesen der Datei "'+file.name+'".');
              if(pending===0){
                if(success>0)msg(el.importMessageArea,success+" Deck(s) erfolgreich importiert. Einige Dateien konnten nicht geladen werden.","success");
                if(errors.length)msg(el.importMessageArea,errors.join(" "),"error");
                renderDecks();renderSelects();renderGoals();renderOverview();
              }
            };
            reader.readAsText(file,"utf-8");
          });
        }
        function addGoal(){
          const name=el.goalNameInput.value,desc=el.goalDescriptionInput.value;
          const deckIds=Array.from(el.goalDecksSelect.options).filter(o=>o.selected).map(o=>o.value);
          try{
            const goal=DataModel.addGoal(name,desc,deckIds);
            msg(el.goalMessageArea,'Lernziel "'+goal.name+'" gespeichert.',"success");
            el.goalNameInput.value="";el.goalDescriptionInput.value="";
            Array.from(el.goalDecksSelect.options).forEach(o=>o.selected=false);
            renderGoals();renderSelects();
          }catch(e){msg(el.goalMessageArea,e.message||"Konnte Lernziel nicht speichern.","error")}
        }
        function clearAll(){
          if(!window.confirm("M√∂chtest du wirklich alle Daten (Decks, Ziele, Sessions) dauerhaft l√∂schen?"))return;
          DataModel.clearAll();currentSession=null;currentQueue=[];currentCardIndex=-1;isBackShown=false;
          updateSessionUI();updateStudyCard();renderDecks();renderGoals();renderSelects();renderOverview();
          msg(el.importMessageArea,"Alle Daten wurden gel√∂scht.","success");
          msg(el.goalMessageArea,"","");msg(el.studyMessageArea,"","");
        }
        function renderOverview(){
          const state=DataModel.getState(),ov=Logic.computeOverview(state);
          el.summaryTotalCards.textContent=ov.totalCards;
          el.summaryTopicCount.textContent=ov.topics.length;
          el.summaryOverallProgress.textContent=Math.round(ov.overallProgress*100)+"%";
          el.topicList.innerHTML="";
          if(!ov.topics.length){
            const li=document.createElement("li");li.className="deck-list-item";
            li.innerHTML='<div class="deck-name muted">Noch keine Themen vorhanden.</div><div class="deck-meta text-right">Importiere Decks, um Themenstatistiken zu sehen.</div>';
            el.topicList.appendChild(li);el.topicSummarySubtitle.textContent="";
          }else{
            ov.topics.forEach(t=>{
              const li=document.createElement("li");li.className="deck-list-item";
              const left=document.createElement("div"),right=document.createElement("div");
              const title=document.createElement("div");title.className="deck-name";title.textContent=t.topic;left.appendChild(title);
              const meta=document.createElement("div");meta.className="deck-meta";meta.textContent=t.learned+"/"+t.total+" Karten gelernt";left.appendChild(meta);
              const rmeta=document.createElement("div");rmeta.className="deck-meta text-right";rmeta.textContent="Fortschritt: "+Math.round(t.progress*100)+"%";right.appendChild(rmeta);
              li.appendChild(left);li.appendChild(right);el.topicList.appendChild(li);
            });
            el.topicSummarySubtitle.textContent=ov.topics.length+" Themen insgesamt";
          }
          drawStatusChart(ov.statusCounts);drawActivityChart();drawBoxplotChart();
        }
        function bind(){
          el.deckFileInput.addEventListener("change",e=>{importFiles(e.target.files);el.deckFileInput.value="";});
          el.addGoalBtn.addEventListener("click",addGoal);
          el.startSessionBtn.addEventListener("click",startSession);
          el.stopSessionBtn.addEventListener("click",stopSession);
          el.flipCardBtn.addEventListener("click",flip);
          el.studyCard.addEventListener("click",flip);
          el.rateNewBtn.addEventListener("click",()=>rate("new"));
          el.rateHardBtn.addEventListener("click",()=>rate("hard"));
          el.rateEasyBtn.addEventListener("click",()=>rate("easy"));
          el.rateLearnedBtn.addEventListener("click",()=>rate("learned"));
          window.addEventListener("keydown",e=>{
            if(e.code==="Space"){e.preventDefault();flip();}
            if(!currentSession)return;
            if(e.key==="1")rate("new");
            if(e.key==="2")rate("hard");
            if(e.key==="3")rate("easy");
            if(e.key==="4")rate("learned");
          });
          el.activityDailyBtn.addEventListener("click",()=>{activityMode="daily";el.activityDailyBtn.classList.add("active");el.activityWeeklyBtn.classList.remove("active");drawActivityChart();});
          el.activityWeeklyBtn.addEventListener("click",()=>{activityMode="weekly";el.activityWeeklyBtn.classList.add("active");el.activityDailyBtn.classList.remove("active");drawActivityChart();});
          el.clearAllBtn.addEventListener("click",clearAll);
          window.addEventListener("resize",renderOverview);
        }
        function init(){cache();bind();renderDecks();renderSelects();renderGoals();renderOverview();updateSessionUI();updateStudyCard();}
        return{init};
      })();
      window.addEventListener("load",function(){DataModel.load();UI.init();});
    })();
  </script>
</body>
</html>