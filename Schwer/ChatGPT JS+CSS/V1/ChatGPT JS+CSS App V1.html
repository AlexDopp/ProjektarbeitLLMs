<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Anki Lern-App (Lokal)</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }
header { background:#2c3e50; color:white; padding:10px 20px; }
section { padding:20px; margin-bottom:20px; background:white; }
h2 { margin-top:0; }
button { padding:6px 12px; margin:4px; cursor:pointer; }
input, select { padding:6px; margin:4px; }
.card { border:1px solid #ccc; padding:20px; min-height:80px; background:#fafafa; }
.hidden { display:none; }
.flex { display:flex; gap:10px; flex-wrap:wrap; }
.stat-box { border:1px solid #ccc; padding:10px; background:#fafafa; }
svg { background:#fff; border:1px solid #ccc; }
.legend span { display:inline-block; margin-right:10px; }
.legend i { width:12px; height:12px; display:inline-block; margin-right:4px; }
</style>
</head>
<body>

<header>
  <h1>Anki Lern- & Fortschritts-App (lokal)</h1>
</header>

<section>
  <h2>1. Deck importieren</h2>
  <input type="file" id="importFile" accept=".json">
  <div id="importError" style="color:red;"></div>
</section>

<section>
  <h2>2. Lernziele</h2>
  <input id="goalName" placeholder="Neues Lernziel">
  <button onclick="UI.addGoal()">Hinzufügen</button>
  <div id="goals"></div>
</section>

<section>
  <h2>3. Deck-Übersicht</h2>
  <div id="deckStats"></div>
</section>

<section>
  <h2>4. Lernsession</h2>
  <select id="sessionDeck"></select>
  <button onclick="UI.startSession()">Session starten</button>
  <button onclick="UI.stopSession()">Session stoppen</button>
  <div id="sessionArea" class="hidden">
    <div class="card" id="cardFront"></div>
    <button onclick="UI.flipCard()">Umdrehen</button>
    <div class="hidden" id="cardBack"></div>
    <div>
      <button onclick="UI.rateCard('new')">Neu</button>
      <button onclick="UI.rateCard('hard')">Schwer</button>
      <button onclick="UI.rateCard('easy')">Leicht</button>
      <button onclick="UI.rateCard('learned')">Gelernt</button>
    </div>
  </div>
</section>

<section>
  <h2>5–7. Lernfortschritt & Aktivität</h2>
  <svg id="progressChart" width="800" height="300"></svg>
  <div class="legend">
    <span><i style="background:#3498db"></i>Neu</span>
    <span><i style="background:#e67e22"></i>Schwer</span>
    <span><i style="background:#2ecc71"></i>Leicht</span>
    <span><i style="background:#9b59b6"></i>Gelernt</span>
  </div>
</section>

<script>
/* =======================
   Datenmodell
======================= */
const Model = {
  state: {
    decks: [],
    goals: [],
    sessions: [],
    currentSession: null
  },
  save() {
    localStorage.setItem("ankiApp", JSON.stringify(this.state));
  },
  load() {
    const d = localStorage.getItem("ankiApp");
    if (d) this.state = JSON.parse(d);
  }
};

/* =======================
   Logik
======================= */
const Logic = {
  importDeck(json) {
    if (!json.deckName || !Array.isArray(json.cards)) {
      throw new Error("Ungültiges Deck-Format");
    }
    json.cards.forEach(c => {
      if (!c.id || !c.front || !c.back || !c.topic) {
        throw new Error("Ungültige Karte im Deck");
      }
      c.status = c.status || "new";
    });
    Model.state.decks.push(json);
    Model.save();
  },
  getAllTopics(deck) {
    return [...new Set(deck.cards.map(c => c.topic))];
  },
  startSession(deckName) {
    const deck = Model.state.decks.find(d => d.deckName === deckName);
    if (!deck) return;
    const cards = [...deck.cards].sort(() => Math.random() - 0.5);
    Model.state.currentSession = {
      deckName,
      cards,
      index: 0,
      start: Date.now()
    };
    Model.save();
  },
  stopSession() {
    if (Model.state.currentSession) {
      const duration = Date.now() - Model.state.currentSession.start;
      Model.state.sessions.push({
        deckName: Model.state.currentSession.deckName,
        duration,
        date: new Date().toISOString().slice(0,10)
      });
      Model.state.currentSession = null;
      Model.save();
    }
  },
  rateCurrentCard(status) {
    const s = Model.state.currentSession;
    if (!s) return;
    const card = s.cards[s.index];
    card.status = status;
    card.lastReviewed = new Date().toISOString().slice(0,10);
    s.index++;
    Model.save();
  }
};

/* =======================
   UI
======================= */
const UI = {
  init() {
    Model.load();
    this.renderGoals();
    this.renderDeckStats();
    this.renderSessionDecks();
    this.renderChart();
  },
  addGoal() {
    const name = document.getElementById("goalName").value.trim();
    if (!name) return;
    Model.state.goals.push({ name, decks: [] });
    Model.save();
    this.renderGoals();
  },
  renderGoals() {
    const div = document.getElementById("goals");
    div.innerHTML = "";
    Model.state.goals.forEach(g => {
      const d = document.createElement("div");
      d.className = "stat-box";
      d.textContent = g.name;
      div.appendChild(d);
    });
  },
  renderDeckStats() {
    const div = document.getElementById("deckStats");
    div.innerHTML = "";
    Model.state.decks.forEach(deck => {
      const topics = {};
      deck.cards.forEach(c => {
        topics[c.topic] = (topics[c.topic] || 0) + 1;
      });
      const box = document.createElement("div");
      box.className = "stat-box";
      box.innerHTML = `<strong>${deck.deckName}</strong><br>
        Karten: ${deck.cards.length}<br>
        Themen: ${Object.entries(topics).map(t => `${t[0]} (${t[1]})`).join(", ")}`;
      div.appendChild(box);
    });
  },
  renderSessionDecks() {
    const sel = document.getElementById("sessionDeck");
    sel.innerHTML = "";
    Model.state.decks.forEach(d => {
      const o = document.createElement("option");
      o.value = d.deckName;
      o.textContent = d.deckName;
      sel.appendChild(o);
    });
  },
  startSession() {
    const deck = document.getElementById("sessionDeck").value;
    Logic.startSession(deck);
    document.getElementById("sessionArea").classList.remove("hidden");
    this.showCard();
  },
  stopSession() {
    Logic.stopSession();
    document.getElementById("sessionArea").classList.add("hidden");
    this.renderChart();
  },
  showCard() {
    const s = Model.state.currentSession;
    if (!s || s.index >= s.cards.length) {
      this.stopSession();
      return;
    }
    document.getElementById("cardFront").textContent = s.cards[s.index].front;
    document.getElementById("cardBack").textContent = s.cards[s.index].back;
    document.getElementById("cardBack").classList.add("hidden");
  },
  flipCard() {
    document.getElementById("cardBack").classList.remove("hidden");
  },
  rateCard(status) {
    Logic.rateCurrentCard(status);
    this.showCard();
  },
  renderChart() {
    const svg = document.getElementById("progressChart");
    svg.innerHTML = "";
    const statuses = ["new","hard","easy","learned"];
    const colors = {
      new:"#3498db", hard:"#e67e22", easy:"#2ecc71", learned:"#9b59b6"
    };
    const data = {};
    Model.state.decks.forEach(d => {
      d.cards.forEach(c => {
        data[c.topic] = data[c.topic] || {new:0,hard:0,easy:0,learned:0};
        data[c.topic][c.status]++;
      });
    });
    const topics = Object.keys(data);
    const barWidth = 40;
    topics.forEach((t,i) => {
      let y = 250;
      statuses.forEach(s => {
        const h = data[t][s] * 10;
        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("x", 50 + i*80);
        rect.setAttribute("y", y - h);
        rect.setAttribute("width", barWidth);
        rect.setAttribute("height", h);
        rect.setAttribute("fill", colors[s]);
        svg.appendChild(rect);
        y -= h;
      });
      const text = document.createElementNS("http://www.w3.org/2000/svg","text");
      text.setAttribute("x", 50 + i*80);
      text.setAttribute("y", 280);
      text.textContent = t;
      svg.appendChild(text);
    });
  }
};

/* =======================
   Events
======================= */
document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      Logic.importDeck(json);
      UI.renderDeckStats();
      UI.renderSessionDecks();
      document.getElementById("importError").textContent = "";
    } catch(err) {
      document.getElementById("importError").textContent = err.message;
    }
  };
  reader.readAsText(file);
});

UI.init();
</script>

</body>
</html>